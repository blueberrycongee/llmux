# LLMux Gateway Configuration
# Environment variables can be used with:
# - ${VAR_NAME}
# - ${VAR_NAME:default}

server:
  port: 8080
  admin_port: 0 # optional: set to expose management/UI on a separate port
  read_timeout: 30s
  write_timeout: 120s
  idle_timeout: 60s

deployment:
  mode: standalone  # standalone, distributed (requires Postgres + Redis), development (allow in-memory)

providers:
  - name: openai
    type: openai
    api_key: ${OPENAI_API_KEY}
    base_url: https://api.openai.com/v1
    models:
      - gpt-4o
      - gpt-4o-mini
      - gpt-4-turbo
      - gpt-3.5-turbo
    max_concurrent: 100
    timeout: 60s

  # Anthropic Claude
  - name: anthropic
    type: anthropic
    api_key: ${ANTHROPIC_API_KEY}
    base_url: https://api.anthropic.com
    models:
      - claude-3-5-sonnet-20241022
      - claude-3-5-haiku-20241022
      - claude-3-opus-20240229
    max_concurrent: 50
    timeout: 120s

  # Google Gemini
  - name: gemini
    type: gemini
    api_key: ${GOOGLE_API_KEY}
    base_url: https://generativelanguage.googleapis.com
    models:
      - gemini-1.5-pro
      - gemini-1.5-flash
      - gemini-2.0-flash-exp
    max_concurrent: 50
    timeout: 60s

  # Azure OpenAI (example - uncomment and configure)
  # - name: azure-openai
  #   type: azure
  #   api_key: ${AZURE_OPENAI_API_KEY}
  #   base_url: https://your-resource.openai.azure.com
  #   models:
  #     - gpt-4
  #   max_concurrent: 50
  #   timeout: 60s
  #   headers:
  #     api-version: "2024-02-15-preview"

routing:
  default_provider: openai
  strategy: simple-shuffle  # simple-shuffle, lowest-latency, least-busy
  fallback_enabled: true
  retry_count: 3
  retry_backoff: 100ms
  retry_max_backoff: 5s
  retry_jitter: 0.2
  cooldown_period: 60s
  distributed: false        # use Redis stats store for multi-instance routing

healthcheck:
  enabled: false
  interval: 30s
  timeout: 10s

stream:
  recovery_mode: retry  # off, append, retry
  max_accumulated_bytes: 1048576  # 0=unlimited (not recommended); caps stream recovery context

rate_limit:
  enabled: false
  requests_per_minute: 60
  burst_size: 10
  distributed: false        # use Redis for distributed rate limiting
  fail_open: true           # allow requests when limiter backend fails
  trusted_proxy_cidrs: []   # trusted proxies for Forwarded/X-Forwarded-For/X-Real-IP

governance:
  enabled: true
  async_accounting: true
  idempotency_window: 10m
  audit_enabled: true

logging:
  level: info   # debug, info, warn, error
  format: json  # json, text

metrics:
  enabled: true
  path: /metrics

# OpenTelemetry Tracing
tracing:
  enabled: false
  endpoint: localhost:4317  # OTLP gRPC endpoint (Jaeger, Tempo, etc.)
  service_name: llmux
  sample_rate: 1.0          # 1.0 = 100% sampling, 0.1 = 10% sampling
  insecure: true            # Set to false for TLS connections

# Observability callbacks (prometheus, otel, otel_metrics, otel_logs, langfuse, s3, slack, datadog, datadog_llm_obs)
observability:
  enabled_callbacks: []

# CORS (production defaults: wildcard disabled)
cors:
  enabled: false
  allow_all_origins: false
  allow_credentials: false
  allow_methods:
    - GET
    - POST
    - PUT
    - PATCH
    - DELETE
    - OPTIONS
  allow_headers:
    - Content-Type
    - Authorization
    - X-Requested-With
  expose_headers: []
  max_age: 10m
  data_origins:
    allowlist: []
    denylist: []
  admin_origins:
    allowlist: []
    denylist: []
  admin_path_prefixes:
    - /key/
    - /team/
    - /user/
    - /organization/
    - /spend/
    - /audit/
    - /global/
    - /invitation/
    - /control/
    - /metrics

# Authentication (API Key validation)
auth:
  enabled: false            # Set to true to require API key authentication
  bootstrap_token: ${LLMUX_BOOTSTRAP_TOKEN} # Optional: emergency/initial bootstrap for management endpoints
  skip_paths:               # Paths that don't require authentication
    - /health/ready
    - /health/live
  last_used_update_interval: 1m # Min interval to update key last_used_at (0 to disable)
  oidc:
    issuer_url: ${OIDC_ISSUER_URL}
    client_id: ${OIDC_CLIENT_ID}
    client_secret: ${OIDC_CLIENT_SECRET}
    claim_mapping:
      role_claim: groups
      roles:
        "admin-group": "llmux-admin"
        "dev-team": "llmux-user"

# PostgreSQL Database (for API keys, teams, usage logging)
database:
  enabled: false            # Set to true to enable database features
  host: ${DB_HOST:localhost}
  port: 5432
  user: ${DB_USER:llmux}
  password: ${DB_PASSWORD}
  database: ${DB_NAME:llmux}
  ssl_mode: disable         # disable, require, verify-ca, verify-full
  max_open_conns: 25
  max_idle_conns: 5
  conn_lifetime: 5m

# Response Caching
cache:
  enabled: false            # Set to true to enable response caching
  type: local               # local (in-memory), redis, dual (local + redis)
  namespace: llmux          # Key namespace prefix for isolation
  ttl: 1h                   # Default cache TTL
  # NOTE: In multi-tenant or untrusted-caller deployments, enable auth.enabled=true.
  # With auth disabled, response caching has no tenant_id isolation and can cross-hit
  # between different callers if requests are identical.

  # In-memory cache settings (used for 'local' and 'dual' types)
  memory:
    max_size: 1000          # Maximum number of cached items
    default_ttl: 10m        # Default TTL for in-memory cache
    max_item_size: 1048576  # Maximum size per item (1MB)
    cleanup_interval: 1m    # Expired entry cleanup interval

  # Redis cache settings (used for 'redis' and 'dual' types)
  redis:
    addr: ${REDIS_ADDR:localhost:6379}
    password: ${REDIS_PASSWORD:}
    db: 0
    # For Redis Cluster, use cluster_addrs instead of addr:
    # cluster_addrs:
    #   - redis-node-1:6379
    #   - redis-node-2:6379
    #   - redis-node-3:6379
    # For Redis Sentinel:
    # sentinel_addrs:
    #   - sentinel-1:26379
    #   - sentinel-2:26379
    # sentinel_master: mymaster
    dial_timeout: 5s
    read_timeout: 3s
    write_timeout: 3s
    pool_size: 10
    min_idle_conns: 2
    max_retries: 3

# HashiCorp Vault Configuration
vault:
  enabled: false
  address: ${VAULT_ADDR}
  auth_method: approle # approle, cert
  role_id: ${VAULT_ROLE_ID}
  secret_id: ${VAULT_SECRET_ID}
  # mTLS Configuration
  # ca_cert: /path/to/ca.pem
  # client_cert: /path/to/client.pem
  # client_key: /path/to/client.key
