# é«˜çº§ Agent è®°å¿†ç³»ç»Ÿ (Advanced Agent Memory System)

`internal/memory` åŒ…ä¸º LLMux Agent æä¾›äº†ä¸€ä¸ªå¤æ‚çš„å¤šå±‚è®°å¿†ç³»ç»Ÿï¼Œæ—¨åœ¨æ¨¡æ‹Ÿç±»äººçš„å›å¿†å’Œå­¦ä¹ èƒ½åŠ›ã€‚å®ƒè¶…è¶Šäº†ç®€å•çš„æ¶ˆæ¯å†å²è®°å½•ï¼Œä½¿ Agent èƒ½å¤Ÿé•¿æœŸå­˜å‚¨ã€ç®¡ç†å’Œæ£€ç´¢ç»“æ„åŒ–çŸ¥è¯†ã€‚

å— [Mem0](https://github.com/mem0ai/mem0) å¯å‘ï¼Œè¯¥ç³»ç»Ÿå®ç°äº†å…·æœ‰æ™ºèƒ½æ‘„å…¥å’Œæ··åˆæ£€ç´¢åŠŸèƒ½çš„åˆ†å±‚æ¶æ„ã€‚

## ğŸ§  æ ¸å¿ƒæ¶æ„

è¯¥ç³»ç»Ÿç”± `MemoryManager` ç¼–æ’ï¼Œåˆ†ä¸ºä¸‰ä¸ªä¸»è¦å±‚çº§ï¼š

1.  **çŸ­æœŸè®°å¿† (Session)**
    *   **ç›®çš„**: ç»´æŠ¤å½“å‰çš„å¯¹è¯ä¸Šä¸‹æ–‡ã€‚
    *   **æœºåˆ¶**: å­˜å‚¨åŸå§‹çš„ `ChatMessage` å†å²è®°å½•ã€‚
    *   **å­˜å‚¨**: å†…å­˜æˆ– Redis (é€šè¿‡ `SessionStore` æ¥å£)ã€‚

2.  **é•¿æœŸè®°å¿† (Vector / RAG)**
    *   **ç›®çš„**: å­˜å‚¨äº‹å®æ€§çŸ¥è¯†ã€ç”¨æˆ·åå¥½å’Œè¿‡å¾€ç»å†ã€‚
    *   **æœºåˆ¶**: ä½¿ç”¨å‘é‡åµŒå…¥ (Embeddings) å’Œæ··åˆç›¸ä¼¼åº¦æœç´¢ã€‚
    *   **å­˜å‚¨**: å‘é‡æ•°æ®åº“ (é€šè¿‡ `VectorStore` æ¥å£)ã€‚

3.  **å®ä½“è®°å¿† (Structured)**
    *   **ç›®çš„**: è¿½è¸ªå®ä½“ (ç”¨æˆ·ã€Agent) çš„ç‰¹å®šå±æ€§ã€‚
    *   **æœºåˆ¶**: é™„åŠ åœ¨è®°å¿†æ¡ç›®ä¸Šçš„ç»“æ„åŒ–å…ƒæ•°æ®ã€‚

## âœ¨ å…³é”®ç‰¹æ€§

### 1. æ™ºèƒ½æ‘„å…¥ (Smart Ingestion)
ç³»ç»Ÿä¸ä»…ä»…æ˜¯å­˜å‚¨åŸå§‹æ–‡æœ¬ï¼Œè€Œæ˜¯åˆ©ç”¨ LLM ä»ç”¨æˆ·è¾“å…¥ä¸­ **æå–** æœ‰æ„ä¹‰çš„äº‹å®ã€‚
*   **æå–**: è¯†åˆ«æ ¸å¿ƒäº‹å®ã€å®ä½“å’Œç±»åˆ« (ä¾‹å¦‚ "hobbies", "work")ã€‚
*   **åŠ¨ä½œå†³ç­–**: LLM å†³å®šæ˜¯æ‰§è¡Œ `ADD` (æ–°å¢)ã€`UPDATE` (æ›´æ–°) è¿˜æ˜¯ `DELETE` (åˆ é™¤) æ“ä½œã€‚

### 2. åŠ¨æ€å†²çªè§£å†³ (Dynamic Resolution)
ç³»ç»Ÿè‡ªåŠ¨å¤„ç†çŸ›ç›¾å’Œæ›´æ–°ï¼š
*   **å»é‡**: ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ (é˜ˆå€¼ `>0.9`) æ£€æµ‹â€œæ–°â€äº‹å®æ˜¯å¦åªæ˜¯ç°æœ‰äº‹å®çš„é‡è¿°ã€‚
*   **å†³è®®**:
    *   **ADD**: å¦‚æœä¸å­˜åœ¨å†²çªï¼Œåˆ™æ·»åŠ æ–°ä¿¡æ¯ã€‚
    *   **UPDATE**: ç”¨æ–°ç»†èŠ‚æ›¿æ¢æ—§ä¿¡æ¯ (ä¾‹å¦‚ï¼Œâ€œæˆ‘æ¬åˆ°äº†æŸæ—â€ æ›¿æ¢ â€œæˆ‘ä½åœ¨å·´é»â€)ã€‚
    *   **DELETE**: æ ¹æ®è¯·æ±‚åˆ é™¤ç‰¹å®šè®°å¿† (ä¾‹å¦‚ï¼Œâ€œå¿˜æ‰æˆ‘çš„ç”µè¯å·ç â€)ã€‚

### 3. æ··åˆæ£€ç´¢ (Hybrid Retrieval)
æ£€ç´¢ä¸ä»…ä»…æ˜¯åŒ¹é…å…³é”®è¯ã€‚æˆ‘ä»¬ä½¿ç”¨æ··åˆè¯„åˆ†å…¬å¼æ¥å‘ˆç°æœ€ç›¸å…³ *ä¸”* æœ€æ–°çš„ä¿¡æ¯ï¼š

$$ Score = (SemanticScore \times 0.8) + (RecencyScore \times 0.2) $$

*   **è¯­ä¹‰è¯„åˆ† (Semantic Score)**: æŸ¥è¯¢å‘é‡ä¸è®°å¿†å‘é‡ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ã€‚
*   **æ—¶æ•ˆè¯„åˆ† (Recency Score)**: æŒ‡æ•°è¡°å‡å‡½æ•° `exp(-0.01 * hours_passed)`ï¼Œä¼˜å…ˆè€ƒè™‘è¾ƒæ–°çš„è®°å¿†ã€‚

## ğŸš€ ä½¿ç”¨æŒ‡å—

### åˆå§‹åŒ–

```go
import (
    "github.com/blueberrycongee/llmux/internal/memory"
    "github.com/blueberrycongee/llmux/internal/memory/inmem"
)

// 1. åˆå§‹åŒ–ç»„ä»¶
sessionStore := inmem.NewInMemorySessionStore()
vectorStore := inmem.NewMemoryVectorStore() // æˆ– Qdrant/Milvus
llmClient := inmem.NewRealLLMClientSimulator() // æˆ– OpenAI Client
embedder := &inmem.SimpleEmbedder{} // æˆ– OpenAI Embedder

// 2. åˆ›å»ºç®¡ç†å™¨
memManager := memory.NewMemoryManager(sessionStore, vectorStore, embedder, llmClient)
```

### æ‘„å…¥è®°å¿† (æ™ºèƒ½æ¨¡å¼)

å°†åŸå§‹ç”¨æˆ·è¾“å…¥ä¼ é€’ç»™ `IngestMemory`ã€‚ç³»ç»Ÿå°†åˆ†æå®ƒå¹¶æ›´æ–°çŠ¶æ€ã€‚

```go
ctx := context.Background()
userID := "user_123"
userInput := "æˆ‘åˆšæ¬åˆ°ä¸œäº¬ï¼Œç°åœ¨å¾ˆå–œæ¬¢åƒå¯¿å¸ã€‚"

// æå–: "User lives in Tokyo", "User likes sushi"
// åŠ¨ä½œ: ADD / UPDATE
err := memManager.IngestMemory(ctx, userID, userInput)
```

### æ£€ç´¢ä¸Šä¸‹æ–‡

ç”Ÿæˆå›å¤æ—¶ï¼Œè·å–ç›¸å…³ä¸Šä¸‹æ–‡ï¼š

```go
query := "æ™šé¥­æˆ‘è¯¥åƒä»€ä¹ˆï¼Ÿ"
contextStr, err := memManager.RetrieveRelevantContext(ctx, query, userID)

// ç»“æœ: "User likes sushi. User lives in Tokyo."
```

## ğŸ›  é…ç½®

è¯¥ç³»ç»Ÿé«˜åº¦æ¨¡å—åŒ–ã€‚ä½ å¯ä»¥é€šè¿‡å®ç°ä»¥ä¸‹æ¥å£æ¥ä½¿ç”¨è‡ªå·±çš„åç«¯ï¼š

*   **`VectorStore`**: ç”¨äºå­˜å‚¨åµŒå…¥ (`Search`, `Add`, `Delete`)ã€‚
*   **`LLMClient`**: ç”¨äºæå–/å†³è®®æ­¥éª¤ (`Call`)ã€‚
*   **`Embedder`**: ç”¨äºç”Ÿæˆå‘é‡åµŒå…¥ (`Embed`)ã€‚
*   **`SessionStore`**: ç”¨äºåŸå§‹èŠå¤©è®°å½•ã€‚

## ğŸ§ª æµ‹è¯•

è¯¥æ¨¡å—åŒ…å«ä¸€ä¸ªå…¨é¢çš„æµ‹è¯•å¥—ä»¶ï¼Œä½¿ç”¨ **ç¡®å®šæ€§æ¨¡æ‹Ÿå™¨ (Deterministic Simulator)** è€Œä¸æ˜¯ Mock å¯¹è±¡ï¼Œç¡®ä¿åœ¨æ²¡æœ‰å¤–éƒ¨ API æˆæœ¬çš„æƒ…å†µä¸‹æµ‹è¯•çœŸå®çš„é€»è¾‘æµã€‚

```bash
go test ./internal/memory/tests/...
```
