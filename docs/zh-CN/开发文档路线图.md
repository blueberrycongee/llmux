# LLMux å¼€å‘è·¯çº¿å›¾

## é¡¹ç›®å®šä½
ç”¨ Go è¯­è¨€é‡æ„ LiteLLM æ ¸å¿ƒåŠŸèƒ½ï¼Œæ‰“é€ ç”Ÿäº§çº§ã€é«˜æ€§èƒ½çš„ LLM ç½‘å…³ã€‚ç›®æ ‡æ˜¯è§£å†³ Python ç‰ˆæœ¬çš„æ€§èƒ½ç“¶é¢ˆï¼ˆGILã€å†…å­˜æ³„æ¼ã€å†·å¯åŠ¨æ…¢ï¼‰ï¼ŒåŒæ—¶å®Œç¾ç»§æ‰¿å…¶æ¨¡å‹å…¼å®¹æ€§å’Œ OpenAI åè®®ç»Ÿä¸€çš„æ ¸å¿ƒä»·å€¼ã€‚

---

## Phase 1: éª¨æ¶æ­å»ºï¼ˆWeek 1-2ï¼‰
**ç›®æ ‡**ï¼šè·‘é€š OpenAI éæµå¼è¯·æ±‚ï¼ŒPrometheus æœ‰æ•°æ®è¾“å‡º

### æ ¸å¿ƒä»»åŠ¡ï¼š

1. **åˆå§‹åŒ– Go é¡¹ç›®ç»“æ„**
   ```
   llmux/
   â”œâ”€â”€ cmd/server/
   â”‚   â””â”€â”€ main.go
   â”œâ”€â”€ internal/
   â”‚   â”œâ”€â”€ api/
   â”‚   â”‚   â””â”€â”€ handler.go
   â”‚   â”œâ”€â”€ provider/
   â”‚   â”‚   â”œâ”€â”€ interface.go
   â”‚   â”‚   â”œâ”€â”€ openai.go
   â”‚   â”‚   â””â”€â”€ manager.go
   â”‚   â”œâ”€â”€ router/
   â”‚   â”‚   â”œâ”€â”€ interface.go
   â”‚   â”‚   â”œâ”€â”€ simple.go
   â”‚   â”‚   â””â”€â”€ manager.go
   â”‚   â”œâ”€â”€ config/
   â”‚   â”‚   â””â”€â”€ manager.go
   â”‚   â””â”€â”€ metrics/
   â”‚       â””â”€â”€ middleware.go
   â”œâ”€â”€ pkg/
   â”‚   â”œâ”€â”€ types/
   â”‚   â””â”€â”€ errors/
   â””â”€â”€ config/
       â””â”€â”€ config.yaml
   ```

2. **å®šä¹‰æ ¸å¿ƒæ¥å£**
   ```go
   // Provider interface
   type Provider interface {
       Name() string
       SupportedModels() []string
       MapParams(openaiParams map[string]any) map[string]any
       BuildRequest(ctx context.Context, req *ChatRequest) (*http.Request, error)
       ParseResponse(resp *http.Response) (*ChatResponse, error)
       ParseStreamChunk(chunk []byte) (*StreamChunk, error)
       MapError(statusCode int, body []byte) error
   }
   
   // Router interface
   type Router interface {
       Pick(ctx context.Context, model string) (*Deployment, error)
       ReportSuccess(deployment *Deployment, latency time.Duration)
       ReportFailure(deployment *Deployment, err error)
       IsCircuitOpen(deployment *Deployment) bool
   }
   
   // ConfigManager interface
   type ConfigManager interface {
       Get() *Config
       Watch(ctx context.Context) <-chan *Config
       Update(newConfig *Config) error
   }
   ```

3. **å®ç° HTTP Server**ï¼ˆä½¿ç”¨ net/httpï¼‰
4. **é›†æˆ Prometheus metrics ä¸­é—´ä»¶**ï¼ˆrequest_total, latency_seconds, token_usageï¼‰
5. **é›†æˆ slog ç»“æ„åŒ–æ—¥å¿—**
6. **å®ç°é…ç½®åŠ è½½ + fsnotify çƒ­é‡è½½**ï¼ˆatomic.Pointer åŸå­æ›¿æ¢ï¼‰
7. **æ‰‹å†™ OpenAI Provider ä½œä¸ºæ¨¡æ¿**
8. **è·‘é€š `/v1/chat/completions`**ï¼ˆéæµå¼ï¼‰

### éªŒæ”¶æ ‡å‡†ï¼š
- `curl` èƒ½æ‰“é€š OpenAI è¯·æ±‚
- Prometheus `/metrics` æœ‰æ•°æ®
- é…ç½®çƒ­é‡è½½ç”Ÿæ•ˆ

---

## Phase 2: AI æ‰¹é‡ç”Ÿæˆ Providerï¼ˆWeek 3ï¼‰
**ç›®æ ‡**ï¼šè¦†ç›– 4-5 ä¸ªä¸»æµ Provider

### æ ¸å¿ƒä»»åŠ¡ï¼š

1. **ä» litellm-main æå–ç±»å‹å®šä¹‰ï¼Œè®© AI ç¿»è¯‘**
   - `types/utils.py` â†’ Go structï¼ˆModelResponse, Usage, Choicesï¼‰
   - `types/llms/openai.py`, `anthropic.py` â†’ Go struct
   - `exceptions.py` â†’ Go error types

2. **è®© AI ç¿»è¯‘ Provider Adapter**
   - `llms/anthropic/chat/transformation.py` â†’ AnthropicProvider
   - `llms/azure/chat/gpt_transformation.py` â†’ AzureProvider
   - `llms/gemini/chat/transformation.py` â†’ GeminiProvider

3. **ç›´æ¥å¤åˆ¶ä»·æ ¼è¡¨**
   ```go
   //go:embed model_prices_and_context_window.json
   var modelPricesJSON []byte
   ```

4. **AI ç”Ÿæˆå‚æ•°æ˜ å°„è¡¨**ï¼ˆOpenAI â†’ Anthropic/Azure/Geminiï¼‰

5. **äººå·¥ Review + ä¿®æ­£**ï¼Œæ¯ä¸ª Adapter è‡³å°‘è·‘ä¸€ä¸ªçœŸå®è¯·æ±‚éªŒè¯

### éªŒæ”¶æ ‡å‡†ï¼š
- æ”¯æŒ OpenAI/Claude/Gemini/Azure
- å¯é€šè¿‡é…ç½®åˆ‡æ¢ Provider
- å‚æ•°æ˜ å°„æ­£ç¡®

---

## Phase 3: SSE æµå¼æ”¯æŒï¼ˆWeek 4ï¼‰
**ç›®æ ‡**ï¼šæµå¼è½¬å‘ç¨³å®šå¯é ï¼Œæ—  goroutine æ³„æ¼

### æ ¸å¿ƒä»»åŠ¡ï¼š

1. **å®ç° SSE è½¬å‘æ ¸å¿ƒé€»è¾‘**
   ```go
   type SSEForwarder struct {
       upstream   io.ReadCloser
       downstream http.ResponseWriter
       clientCtx  context.Context
       bufferPool *sync.Pool
   }
   ```

2. **sync.Pool buffer å¤ç”¨**ï¼Œé¿å…é«˜é¢‘ GC
3. **client æ–­å¼€æ£€æµ‹ + ä¸Šæ¸¸ cancel**ï¼ˆcontext.Done ç›‘å¬ï¼‰
4. **å„ Provider çš„æµå¼å“åº”æ ¼å¼é€‚é…**ï¼ˆAnthropic çš„ `event:` å‰ç¼€å¤„ç†ï¼‰
5. **ç¼–å†™æµå¼ç›¸å…³æµ‹è¯•ç”¨ä¾‹**ï¼ˆmock server + å¼‚å¸¸æ³¨å…¥ï¼‰

### éªŒæ”¶æ ‡å‡†ï¼š
- SSE æ­£å¸¸å·¥ä½œ
- client æ–­å¼€èƒ½ç«‹å³ cancel ä¸Šæ¸¸
- æ— å†…å­˜æ³„æ¼
- goroutine æ•°é‡ç¨³å®š

---

## Phase 4: é«˜å¯ç”¨ï¼ˆWeek 5-6ï¼‰âœ… å·²å®Œæˆ
**ç›®æ ‡**ï¼šç”Ÿäº§çº§ç¨³å®šæ€§ï¼Œèƒ½æ‰›ä½æµé‡çªå¢

### å·²å®Œæˆä»»åŠ¡ï¼š

1. **âœ… è‡ªç ”ç†”æ–­å™¨ (Circuit Breaker)**
   - ä¸‰æ€æ¨¡å‹ï¼šClosed â†’ Open â†’ Half-Open
   - å¯é…ç½®å¤±è´¥é˜ˆå€¼ã€è¶…æ—¶æ—¶é—´
   - çŠ¶æ€å˜æ›´å›è°ƒæ”¯æŒ
   - æµ‹è¯•è¦†ç›–ç‡ 97.6%

2. **âœ… Bulkhead èˆ±å£æ¨¡å¼ (Semaphore)**
   - Context-aware é˜»å¡è·å–
   - è¶…æ—¶å–æ¶ˆæ”¯æŒ
   - å…¬å¹³å”¤é†’æœºåˆ¶

3. **âœ… Token Bucket é™æµå™¨**
   - æ”¯æŒçªå‘æµé‡
   - åŠ¨æ€è°ƒæ•´é€Ÿç‡
   - ä»¤ç‰ŒæŸ¥è¯¢æ¥å£

4. **âœ… ç»Ÿä¸€ç®¡ç†å™¨ (Manager)**
   - æŒ‰ Provider/Deployment éš”ç¦»
   - æ‡’åŠ è½½ç»„ä»¶
   - ç»Ÿè®¡ä¿¡æ¯æŸ¥è¯¢

5. **âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹**ï¼ˆ`/health/live`, `/health/ready`ï¼‰

6. **âœ… ä¼˜é›…å…³é—­**ï¼ˆSIGTERM ä¿¡å·å¤„ç†ï¼‰

### å¾…é›†æˆï¼š
- å°† resilience ç»„ä»¶é›†æˆåˆ° Handler ä¸­
- è·¯ç”±ç­–ç•¥æ‰©å±•ï¼ˆLowest Latency, Least Busyï¼‰

### éªŒæ”¶æ ‡å‡†ï¼š
- âœ… ç†”æ–­å™¨æµ‹è¯•é€šè¿‡
- âœ… é™æµå™¨æµ‹è¯•é€šè¿‡
- âœ… å¹¶å‘æ§åˆ¶æµ‹è¯•é€šè¿‡
- ğŸ”² å‹æµ‹éªŒè¯ï¼ˆå¾… Handler é›†æˆåï¼‰

---

## Phase 5: å¯è§‚æµ‹æ€§å¢å¼ºï¼ˆWeek 7ï¼‰âœ… å·²å®Œæˆ
**ç›®æ ‡**ï¼šæˆä¸º AI æµé‡çš„"æ˜¾å¾®é•œ"

### å·²å®Œæˆä»»åŠ¡ï¼š

1. **âœ… OpenTelemetry Tracing**
   - OTLP gRPC å¯¼å‡ºå™¨
   - LLM ä¸“ç”¨ Span å±æ€§ (gen_ai.system, gen_ai.request.model)
   - å¯é…ç½®é‡‡æ ·ç‡
   - Jaeger/Tempo/Zipkin å…¼å®¹

2. **âœ… æ—¥å¿—è„±æ• (Redactor)**
   - API Key è‡ªåŠ¨ mask (OpenAI/Anthropic/Google)
   - Bearer Token è„±æ•
   - é‚®ç®±ã€ç”µè¯ã€ä¿¡ç”¨å¡ã€SSN ç­‰ PII ä¿æŠ¤
   - HTTP Header æ•æ„Ÿå­—æ®µè¿‡æ»¤

3. **âœ… Request ID ä¸­é—´ä»¶**
   - è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€è¯·æ±‚ ID
   - æ”¯æŒä¼ å…¥ X-Request-ID å¤´
   - Context ä¼ é€’ï¼Œæ—¥å¿—å…³è”

4. **âœ… ç»“æ„åŒ–æ—¥å¿—å°è£…**
   - slog å°è£…ï¼Œæ”¯æŒ JSON/Text æ ¼å¼
   - è‡ªåŠ¨è„±æ•è¾“å‡º
   - Request ID è‡ªåŠ¨æ³¨å…¥

### å¾…å®Œæˆï¼š
- tiktoken-go Token ä¼°ç®—
- æˆæœ¬è®¡ç®—é€»è¾‘

### æµ‹è¯•è¦†ç›–ç‡ï¼š82.0%

### éªŒæ”¶æ ‡å‡†ï¼š
- âœ… OpenTelemetry é›†æˆå®Œæˆ
- âœ… æ—¥å¿—è„±æ•ç”Ÿæ•ˆ
- âœ… Request ID å…³è”
- ğŸ”² Grafana ç›‘æ§é¢æ¿ï¼ˆå¾…éƒ¨ç½²éªŒè¯ï¼‰

---

## Phase 6: äº‘åŸç”Ÿæ‰“åŒ…ï¼ˆWeek 8ï¼‰âœ… å·²å®Œæˆ
**ç›®æ ‡**ï¼šdocker pull å°±èƒ½è·‘ï¼Œé•œåƒ < 20MB

### å·²å®Œæˆä»»åŠ¡ï¼š

1. **âœ… å¤šé˜¶æ®µ Dockerfile**
   - distroless åŸºç¡€é•œåƒ
   - é root ç”¨æˆ·è¿è¡Œ
   - åªè¯»æ–‡ä»¶ç³»ç»Ÿ

2. **âœ… Helm Chart**
   - Deployment, Service, ConfigMap
   - HPA è‡ªåŠ¨æ‰©ç¼©å®¹
   - Ingress é…ç½®
   - ServiceAccount
   - å®‰å…¨ä¸Šä¸‹æ–‡

3. **âœ… K8s manifests ç¤ºä¾‹**
   - Namespace, Secret, ConfigMap
   - Deployment, Service

4. **âœ… CI/CD pipeline**
   - GitHub Actions
   - lint â†’ test â†’ build
   - å¤šå¹³å°é•œåƒ (amd64/arm64)
   - è‡ªåŠ¨å‘å¸ƒ Release

### å¾…å®Œæˆï¼š
- Unix Domain Socket æ”¯æŒ

### éªŒæ”¶æ ‡å‡†ï¼š
- âœ… Distroless é•œåƒ
- âœ… Helm Chart å®Œæˆ
- âœ… CI/CD è‡ªåŠ¨åŒ–
- ğŸ”² é•œåƒå¤§å°éªŒè¯ï¼ˆå¾…æ„å»ºï¼‰

---

## é‡Œç¨‹ç¢‘æ£€æŸ¥ç‚¹

| é‡Œç¨‹ç¢‘ | æ—¶é—´ | éªŒæ”¶æ ‡å‡† |
|--------|------|----------|
| M1: éª¨æ¶å®Œæˆ | Week 2 | âœ… curl æ‰“é€š OpenAI éæµå¼ï¼ŒPrometheus æœ‰æ•°æ® |
| M2: å¤š Provider | Week 3 | âœ… æ”¯æŒ OpenAI/Claude/Gemini/Azure |
| M3: æµå¼å¯ç”¨ | Week 4 | âœ… SSE æ­£å¸¸ï¼Œclient æ–­å¼€èƒ½ cancel ä¸Šæ¸¸ |
| M4: é«˜å¯ç”¨ | Week 6 | âœ… ç†”æ–­/é™æµ/å¹¶å‘æ§åˆ¶å®Œæˆ |
| M5: å¯è§‚æµ‹ | Week 7 | âœ… OpenTelemetry/æ—¥å¿—è„±æ•/Request ID |
| M6: å¯éƒ¨ç½² | Week 8 | âœ… Helm Chart, CI/CD |

---

## æŠ€æœ¯é€‰å‹

| æ¨¡å— | é€‰å‹ | ç†ç”± |
|------|------|------|
| HTTP Server | net/http æˆ– fasthttp | æ ‡å‡†åº“è¶³å¤Ÿï¼Œfasthttp å¯é€‰ |
| ç†”æ–­å™¨ | sony/gobreaker | æˆç†Ÿç¨³å®š |
| é…ç½®çƒ­é‡è½½ | fsnotify + atomic.Pointer | é›¶åœæœºæ›´æ–° |
| Metrics | prometheus/client_golang | è¡Œä¸šæ ‡å‡† |
| æ—¥å¿— | slog (Go 1.21+) | å®˜æ–¹æ”¯æŒï¼Œç»“æ„åŒ– |
| Tracing | OpenTelemetry SDK | äº‘åŸç”Ÿæ ‡å‡† |
| Token è®¡æ•° | pkoukk/tiktoken-go | çº¯ Go å®ç° |
| é™æµå™¨ | golang.org/x/time/rate | å®˜æ–¹åº“ï¼Œæ”¯æŒ Token Bucket |
| é…ç½®æ ¼å¼ | YAML | å¯è¯»æ€§å¥½ï¼Œç»“æ„æ¸…æ™° |
| æ•°æ®åº“ | PostgreSQL | ä¸ LiteLLM ä¸€è‡´ï¼Œæˆç†Ÿç¨³å®š |
| ç¼“å­˜ | Redis | é«˜æ€§èƒ½ï¼Œæ”¯æŒåˆ†å¸ƒå¼ |
| æµ‹è¯•æ¡†æ¶ | testify | ç¤¾åŒºå¹¿æ³›ä½¿ç”¨ |

---

## é£é™©ä¸åº”å¯¹

| é£é™© | åº”å¯¹ç­–ç•¥ |
|------|----------|
| AI ç”Ÿæˆä»£ç æœ‰ bug | æ¯ä¸ª Adapter å¿…é¡»è·‘çœŸå®è¯·æ±‚éªŒè¯ |
| Provider API å˜æ›´ | Adapter è®¾è®¡æ˜“äºä¿®æ”¹ï¼Œå…³æ³¨ changelog |
| æµå¼å®ç°å¤æ‚ | å…ˆåš OpenAIï¼ˆæœ€æ ‡å‡†ï¼‰ï¼Œå…¶ä»–å‚è€ƒå®ƒæ”¹ |
| æ€§èƒ½ä¸è¾¾é¢„æœŸ | æ—©æœŸåŠ  benchmarkï¼ŒæŒç»­ç›‘æ§ |
| ä¸ Python ç‰ˆæ•°æ®å…¼å®¹ | å¤ç”¨ Redis key ç»“æ„å’Œ Postgres schema |
| Provider è¿‡å¤šç»´æŠ¤å›°éš¾ | æ’ä»¶åŒ–è®¾è®¡ï¼Œæ”¯æŒå¤–éƒ¨ Adapter |

---

## å·¥ä½œåˆ†é…å»ºè®®

### AI æ‰¹é‡ç”Ÿæˆï¼ˆè„æ´»ç´¯æ´»ï¼‰ï¼š
- ç±»å‹å®šä¹‰ç¿»è¯‘ï¼ˆstruct + json tagï¼‰
- å‚æ•°æ˜ å°„è¡¨
- é”™è¯¯ç æ˜ å°„
- å•å…ƒæµ‹è¯• cases
- æ–‡æ¡£æ³¨é‡Šç”Ÿæˆ

### äººå·¥æŠŠæ§ï¼ˆç²¾ç»†æ´»ï¼‰ï¼š
- SSE æµå¼è½¬å‘ï¼ˆèƒŒå‹ã€è¿æ¥æ£€æµ‹ã€buffer å¤ç”¨ï¼‰
- ç†”æ–­å™¨è°ƒå‚
- é…ç½®çƒ­é‡è½½ï¼ˆåŸå­æ€§ã€ä¸€è‡´æ€§ï¼‰
- Metrics label è®¾è®¡ï¼ˆcardinality æ§åˆ¶ï¼‰
- è¶…æ—¶å±‚çº§è®¾è®¡
- æ ¸å¿ƒæ¥å£å®šä¹‰
- æ€§èƒ½è°ƒä¼˜
- å®‰å…¨å®¡è®¡

---

## æ ¸å¿ƒæ¥å£å®šä¹‰ï¼ˆè¯¦ç»†ç‰ˆï¼‰

```go
// æ ¸å¿ƒè¯·æ±‚/å“åº”ç±»å‹
type ChatRequest struct {
    Model    string        `json:"model"`
    Messages []ChatMessage `json:"messages"`
    Stream   bool          `json:"stream,omitempty"`
    MaxTokens int          `json:"max_tokens,omitempty"`
    Temperature float64    `json:"temperature,omitempty"`
    // ... å…¶ä»– OpenAI å…¼å®¹å‚æ•°
}

type ChatResponse struct {
    ID      string    `json:"id"`
    Object  string    `json:"object"`
    Created int64     `json:"created"`
    Model   string    `json:"model"`
    Choices []Choice  `json:"choices"`
    Usage   *Usage    `json:"usage,omitempty"`
}

// éƒ¨ç½²é…ç½®
type Deployment struct {
    ID           string            `json:"id"`
    ModelName    string            `json:"model_name"`
    Provider     string            `json:"provider"`
    BaseURL      string            `json:"base_url"`
    APIKey       string            `json:"-"`
    MaxConcurrent int              `json:"max_concurrent"`
    Timeout      time.Duration     `json:"timeout"`
    MaxRetries   int               `json:"max_retries"`
    CoolDown     time.Duration     `json:"cool_down"`
    Metadata     map[string]string `json:"metadata"`
}
```

---

## æ€§èƒ½ç›®æ ‡
- å»¶è¿Ÿï¼šP99 < 100ms
- ååï¼š1000 QPS
- å†…å­˜ï¼š< 100MB
- è¿æ¥æ•°ï¼šæ”¯æŒ 10k å¹¶å‘
- å†·å¯åŠ¨ï¼š< 1s
- é•œåƒå¤§å°ï¼š< 20MB