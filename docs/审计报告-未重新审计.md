> æ³¨æ„ï¼šè¿™ä»½æ–‡ä»¶æ˜¯â€œç°åœºéªŒè¯ç¬”è®°/æœªé‡æ–°å®¡è®¡â€çš„åŸå§‹è®°å½•ã€‚  
> å·²åŸºäºåŒä¸€åŸºçº¿æäº¤ï¼ˆ`ed4f36149b3...`ï¼‰è¾“å‡ºä¸€ä»½â€œé‡å®¡åçš„ä¿®å¤é¡ºåºæŠ¥å‘Šâ€ï¼š`docs/å®¡è®¡æŠ¥å‘Š-é‡å®¡-ä¿®å¤é¡ºåº.md`ã€‚  
> å»ºè®®ä»¥æ–°æŠ¥å‘Šä¸ºå‡†ï¼ˆå®ƒæŒ‰ä¼ä¸šçº§ç½‘å…³æ ‡å‡†é‡æ–°åˆ†çº§å¹¶æ’åºï¼‰ï¼Œæœ¬æ–‡ä»¶ä¿ç•™ç”¨äºè¿½æº¯è¯æ®ä¸è®¨è®ºã€‚

æ—¶é—´ åŒ—äº¬æ—¶é—´ 2026 1 13 23ï¼š13
å®¡è®¡æŠ¥å‘ŠéªŒè¯æ€»ç»“
âœ… ç¡®è®¤æ­£ç¡®çš„ï¼ˆ6 ä¸ªï¼‰
| ID | é—®é¢˜ | éªŒè¯ç»“è®º | |----|------|----------| | R1 | ç®¡ç†é¢è½åœ¨ data port ä¸”å¯æ— é‰´æƒ | âœ… ä»£ç ç¡®è®¤ï¼šadmin_port=0 æ—¶ç®¡ç†è·¯ç”±æ³¨å†Œåˆ° Data mux | | R2 | KeyType å®šä¹‰äº†ä½†ä»æœª enforce | âœ… ä»£ç ç¡®è®¤ï¼štypes.go å®šä¹‰äº† KeyTypeï¼Œä½† middleware ä»æœªæ£€æŸ¥ | | R4 | OIDC ä¸ API Key middleware å†²çª | âœ… ä»£ç ç¡®è®¤ï¼šAPI Key middleware ä¸æ£€æŸ¥å·²æœ‰ AuthContext | | R5 | Streaming chunk 16KB ä¸Šé™ | âœ… ä»£ç ç¡®è®¤ï¼šscanner.Buffer(..., 4096*4) | | R6 | Streaming è¢«å…¨å±€ Timeout æˆªæ–­ | âœ… ä»£ç ç¡®è®¤ï¼šhttp.Client{Timeout: cfg.Timeout} | | R8 | Invitation endpoints ä¸å¯è¾¾ | âœ… ä»£ç ç¡®è®¤ï¼šRegisterInvitationRoutes ä»æœªè¢«è°ƒç”¨ |

âš ï¸ æˆ‘è´¨ç–‘çš„ï¼ˆ2 ä¸ªï¼‰
| ID | é—®é¢˜ | è´¨ç–‘ç‚¹ | |----|------|--------| | R3 | åˆ†å¸ƒå¼é…ç½®é»˜è®¤ç¦ç”¨ governance | å®¡è®¡å¼•ç”¨çš„ config.distributed.yaml æ˜¯æˆ‘åˆšæ‰åˆ›å»ºçš„æµ‹è¯•é…ç½®ï¼Œä¸æ˜¯é¡¹ç›®åŸæœ‰çš„ã€‚é¡¹ç›®åŸå§‹ config.example.yaml ä¸­ governance.enabled: trueã€‚çœŸæ­£é—®é¢˜åº”è¯¥æ˜¯ ModelAccessMiddleware æœªæ¥å…¥ middleware stack | | R7 | åŒé‡é™æµï¼ˆgovernance + clientï¼‰ | è¿™å¯èƒ½æ˜¯æœ‰æ„è®¾è®¡ï¼šgovernance åšç§Ÿæˆ·çº§é™æµï¼Œclient åš provider çº§ä¿æŠ¤ã€‚å»ºè®®é™çº§ä¸º P2 æˆ–æ ‡æ³¨"éœ€è¦æ–‡æ¡£è¯´æ˜èŒè´£è¾¹ç•Œ" |

æ”»å‡»é¢å®¡è®¡æŠ¥å‘ŠéªŒè¯æ€»ç»“
âœ… ç¡®è®¤æ­£ç¡®çš„
| é—®é¢˜ | éªŒè¯ç»“è®º | |------|----------| | P0: é»˜è®¤å…¬å¼€ç®¡ç† API + UI | âœ… æ­£ç¡®ã€‚admin_port=0 + auth.enabled=false æ—¶ç®¡ç† API å®Œå…¨è£¸å¥” | | P0: ç®¡ç† API ç¼ºå°‘ç»†ç²’åº¦æˆæƒ | âœ… æ­£ç¡®ã€‚GenerateKey() ç­‰ç›´æ¥ json.Decode(r.Body) æ— ä»»ä½•è§’è‰²æ£€æŸ¥ | | P1: /metrics é»˜è®¤å¼€å¯ä¸”åœ¨ data ç«¯å£ | âœ… æ­£ç¡®ã€‚routes.go ä¸­ metrics æ³¨å†Œåœ¨ data mux | | P1: management é¢è¯·æ±‚ä½“æœªé™åˆ¶ | âœ… æ­£ç¡®ã€‚management.go ä¸­ json.NewDecoder(r.Body).Decode() æ—  MaxBytesReader | | P2: X-Request-ID å®Œå…¨ä¿¡ä»» | âœ… æ­£ç¡®ã€‚requestid.go:42-45 ç›´æ¥ä½¿ç”¨å®¢æˆ·ç«¯ä¼ å…¥çš„å€¼ï¼Œæ— é•¿åº¦/å­—ç¬¦é™åˆ¶ | | æ­»ä»£ç : RateLimitMiddleware æœªæ¥å…¥ | âœ… æ­£ç¡®ã€‚å­˜åœ¨ä½†æœªåœ¨ middleware stack ä¸­ä½¿ç”¨ | | æ­»ä»£ç : ModelAccessMiddleware æœªæ¥å…¥ | âœ… æ­£ç¡®ã€‚å­˜åœ¨ä½†æœªåœ¨ middleware stack ä¸­ä½¿ç”¨ | | æ­»ä»£ç : ToolInjectionMiddleware æœªæ¥å…¥ | âœ… æ­£ç¡®ã€‚å®šä¹‰äº†ä½†å…¨ä»“åº“æ— å¼•ç”¨ | | Data é¢æœ‰ 10MB é™åˆ¶ | âœ… æ­£ç¡®ã€‚handler.go:19 DefaultMaxBodySize = 10MBï¼ŒChatCompletions() ä½¿ç”¨ io.LimitReader | | Forwarded/X-Forwarded- ä¿¡ä»»ç­–ç•¥* | âœ… æ­£ç¡®ã€‚ä»…åœ¨ TrustedProxyCIDRs å†…æ‰è¯»å–ï¼Œç”¨äºé™æµ key æ¨å¯¼ |

âš ï¸ æˆ‘çš„è¡¥å……æ„è§
| é—®é¢˜ | è¡¥å…… | |------|------| | Streaming å†…å­˜æ”¾å¤§ | æŠ¥å‘Šæåˆ° strings.Builder ç´¯ç§¯ï¼Œä½†ä¹‹å‰éªŒè¯è¿‡æœ‰ maxRetries é™åˆ¶ï¼Œé£é™©å¯æ§ | | HTTP è¯·æ±‚èµ°ç§ | æŠ¥å‘Šæ­£ç¡®æŒ‡å‡º"Go net/http ç›´è¿æ— è‡ªç ”ä»£ç†å±‚"ï¼Œä½†å»ºè®®è¡¥å……"å‰ç½®ä»£ç†éœ€åš HTTP/1.1 èµ°ç§é˜²æŠ¤" |

ä¸¤ä»½æŠ¥å‘Šå¯¹æ¯”
| ç»´åº¦ | ç¬¬ä¸€ä»½æŠ¥å‘Šï¼ˆé“¾è·¯/æ²»ç†ï¼‰ | ç¬¬äºŒä»½æŠ¥å‘Šï¼ˆæ”»å‡»é¢ï¼‰ | |------|------------------------|---------------------| | ä¾§é‡ç‚¹ | åŠŸèƒ½é“¾è·¯ã€æ¨¡å—äº¤æ¥ã€æ²»ç†æ–­æ¡£ | å®‰å…¨è¾¹ç•Œã€DoSã€æ­»ä»£ç  | | P0 é—®é¢˜ | R1-R4ï¼ˆç®¡ç†é¢æˆæƒã€OIDC å†²çªï¼‰ | ç®¡ç†é¢è£¸å¥”ã€è¯·æ±‚ä½“æ— é™åˆ¶ | | é‡å ç‚¹ | ç®¡ç† API æˆæƒé—®é¢˜ | ç®¡ç† API æˆæƒé—®é¢˜ | | äº’è¡¥ç‚¹ | æ²»ç†/é™æµåŒé‡é—®é¢˜ | X-Request-ID æ³¨å…¥ã€metrics æš´éœ² |

æŠ¥å‘Š 3 éªŒè¯ç»“æœ
âœ… P0: å¯¹è±¡æ± è·¨è¯·æ±‚æ±¡æŸ“ - ç¡®è®¤ï¼
åœ¨ LLMux/pkg/types/request.go çš„ Reset() æ–¹æ³•ä¸­ï¼š

func (r *ChatRequest) Reset() {
    r.Model = ""
    r.Messages = r.Messages[:0]
    r.Stream = false
    r.MaxTokens = 0
    r.Temperature = nil
    r.TopP = nil
    r.N = 0
    r.Stop = r.Stop[:0]
    r.PresencePenalty = nil
    r.FrequencyPenalty = nil
    r.User = ""
    r.Tools = r.Tools[:0]
    r.ToolChoice = nil
    r.ResponseFormat = nil
    r.Tags = nil
    r.Extra = nil
    // âŒ ç¼ºå°‘: r.StreamOptions = nil
}
é—®é¢˜ç¡®è®¤ï¼šStreamOptions å­—æ®µæ²¡æœ‰è¢«æ¸…ç†ï¼å¦‚æœè¯·æ±‚ A è®¾ç½®äº† StreamOptionsï¼Œè¯·æ±‚ B å¤ç”¨åŒä¸€å¯¹è±¡æ—¶ä¼šç»§æ‰¿è¿™ä¸ªå€¼ã€‚

âœ… P1: å¼ºåˆ¶ include_usage - ç¡®è®¤ï¼
åœ¨ client_handler.go ç¬¬ 155-159 è¡Œï¼š

// Force include_usage to get accurate token counts from supported providers (e.g. OpenAI)
if req.StreamOptions == nil {
    req.StreamOptions = &llmux.StreamOptions{IncludeUsage: true}
} else {
    req.StreamOptions.IncludeUsage = true
}
é—®é¢˜ç¡®è®¤ï¼šæ— è®ºå®¢æˆ·ç«¯æ˜¯å¦è®¾ç½® include_usage: falseï¼Œéƒ½ä¼šè¢«å¼ºåˆ¶è¦†ç›–ä¸º trueã€‚è¿™æ”¹å˜äº† OpenAI API çš„è¯­ä¹‰ã€‚

âœ… P1: Streaming 16KB ä¸Šé™ - ç¡®è®¤ï¼
åœ¨ stream.go ç¬¬ 82-84 è¡Œï¼š

scanner := bufio.NewScanner(body)
// Increase buffer size for large chunks
scanner.Buffer(make([]byte, 4096), 4096*4)  // = 16KB
é—®é¢˜ç¡®è®¤ï¼šæœ€å¤§ buffer ä¸º 16KBï¼Œè¶…é•¿ chunk ä¼šå¯¼è‡´ bufio.Scanner: token too long é”™è¯¯ã€‚

âœ… P1: Streaming å†…å­˜ç´¯ç§¯ - ç¡®è®¤ä½†æœ‰é™åˆ¶
åœ¨ stream.go ä¸­ï¼Œaccumulated strings.Builder ä¼šç´¯ç§¯æ‰€æœ‰å†…å®¹ï¼š

// Accumulate content for recovery
if len(chunk.Choices) > 0 {
    s.accumulated.WriteString(chunk.Choices[0].Delta.Content)
}
é£é™©è¯„ä¼°ï¼š

ç´¯ç§¯ç”¨äº stream recovery å’Œ token ä¼°ç®—
æœ‰ maxRetries é™åˆ¶ï¼ˆé»˜è®¤ 3 æ¬¡ï¼‰
ä½†å¦‚æœå“åº”æœ¬èº«å¾ˆå¤§ï¼ˆå¦‚ä»£ç ç”Ÿæˆï¼‰ï¼Œä»ä¼šå ç”¨å¤§é‡å†…å­˜
éœ€è¦éªŒè¯ P2: é”™è¯¯ä¿¡æ¯æ³„éœ²
Searched workspace
éªŒè¯ P2 é—®é¢˜ï¼šerr.Error() æ˜¯å¦ç›´æ¥æš´éœ²ç»™å®¢æˆ·ç«¯
Searched workspace
éªŒè¯é”™è¯¯å¤„ç†ï¼šæŸ¥çœ‹ writeError å¦‚ä½•å¤„ç†é”™è¯¯æ¶ˆæ¯
Searched workspace
éªŒè¯é”™è¯¯å¤„ç†ï¼šæŸ¥çœ‹ LLMError å¦‚ä½•æ„é€ 
Searched workspace
éªŒè¯é”™è¯¯å¤„ç†ï¼šæŸ¥çœ‹é”™è¯¯å¦‚ä½•è¿”å›ç»™å®¢æˆ·ç«¯
Read file(s)

errors.go
ç°åœ¨æˆ‘çœ‹åˆ°äº†é”™è¯¯å¤„ç†ã€‚è®©æˆ‘æ£€æŸ¥ client_handler.go ä¸­çš„ writeError æ–¹æ³•å¦‚ä½•ä½¿ç”¨è¿™äº›é”™è¯¯ï¼š

ä»ä¹‹å‰è¯»å–çš„ client_handler.go ä¸­ï¼Œæˆ‘çœ‹åˆ°äº† writeError æ–¹æ³•ï¼ˆç¬¬ 595-612 è¡Œï¼‰ï¼š

func (h *ClientHandler) writeError(w http.ResponseWriter, err error) {
    var llmErr *llmerrors.LLMError
    if e, ok := err.(*llmerrors.LLMError); ok {
        llmErr = e
    } else {
        llmErr = llmerrors.NewInternalError("", "", err.Error())  // â† P2 é—®é¢˜ï¼
    }

    w.Header().Set("Content-Type", "application/json")
    w.WriteHeader(llmErr.HTTPStatusCode())

    resp := ErrorResponse{
        Error: ErrorDetail{
            Message: llmErr.Message,  // â† ç›´æ¥æš´éœ²ç»™å®¢æˆ·ç«¯
            Type:    llmErr.Type,
        },
    }
    // ...
}
âœ… P2: é”™è¯¯ä¿¡æ¯æ³„éœ² - ç¡®è®¤ï¼
å½“é”™è¯¯ä¸æ˜¯ LLMError ç±»å‹æ—¶ï¼Œä¼šè°ƒç”¨ llmerrors.NewInternalError("", "", err.Error())ï¼Œå°†åŸå§‹é”™è¯¯ä¿¡æ¯ç›´æ¥ä½œä¸º message è¿”å›ç»™å®¢æˆ·ç«¯ã€‚è¿™å¯èƒ½æ³„éœ²ï¼š

æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
å†…éƒ¨ IP åœ°å€
æ–‡ä»¶è·¯å¾„
å †æ ˆä¿¡æ¯
ğŸ“‹ æŠ¥å‘Š 3 éªŒè¯æ€»ç»“
| ID | é—®é¢˜ | ä¸¥é‡æ€§ | éªŒè¯ç»“æœ | |----|------|--------|----------| | P0 | å¯¹è±¡æ± è·¨è¯·æ±‚æ±¡æŸ“ï¼šReset() æœªæ¸…ç† StreamOptions | P0 | âœ… ç¡®è®¤ | | P1 | å¼ºåˆ¶ include_usage: true æ”¹å˜ OpenAI è¯­ä¹‰ | P1 | âœ… ç¡®è®¤ | | P1 | Streaming 16KB buffer ä¸Šé™ | P1 | âœ… ç¡®è®¤ | | P1 | Streaming å†…å­˜ç´¯ç§¯ï¼ˆç”¨äº recoveryï¼‰ | P1 | âš ï¸ ç¡®è®¤ä½†æœ‰é™åˆ¶ï¼ˆmaxRetries æ§åˆ¶ï¼‰ | | P2 | é”™è¯¯ä¿¡æ¯æ³„éœ²ï¼šé LLMError çš„ err.Error() ç›´æ¥è¿”å› | P2 | âœ… ç¡®è®¤ |

ğŸ”§ ä¿®å¤å»ºè®®
P0 ä¿®å¤ï¼ˆç«‹å³ï¼‰
// pkg/types/request.go - Reset() æ–¹æ³•
func (r *ChatRequest) Reset() {
    // ... ç°æœ‰ä»£ç  ...
    r.ResponseFormat = nil
    r.StreamOptions = nil  // â† æ·»åŠ è¿™è¡Œï¼
    r.Tags = nil
    r.Extra = nil
}
P1 ä¿®å¤
include_usage å¼ºåˆ¶é—®é¢˜ï¼šæ”¹ä¸ºåªåœ¨ StreamOptions == nil æ—¶è®¾ç½®é»˜è®¤å€¼ï¼Œä¸è¦†ç›–ç”¨æˆ·è®¾ç½®


if req.StreamOptions == nil {
    req.StreamOptions = &llmux.StreamOptions{IncludeUsage: true}
}
// ç§»é™¤ else åˆ†æ”¯ï¼Œå°Šé‡ç”¨æˆ·è®¾ç½®
16KB buffer ä¸Šé™ï¼šå¢åŠ åˆ° 64KB æˆ– 128KB

scanner.Buffer(make([]byte, 4096), 128*1024)  // 128KB
P2 ä¿®å¤
func (h *ClientHandler) writeError(w http.ResponseWriter, err error) {
    var llmErr *llmerrors.LLMError
    if e, ok := err.(*llmerrors.LLMError); ok {
        llmErr = e
    } else {
        // ä¸æš´éœ²åŸå§‹é”™è¯¯ï¼Œä½¿ç”¨é€šç”¨æ¶ˆæ¯
        h.logger.Error("internal error", "error", err)  // åªè®°å½•æ—¥å¿—
        llmErr = llmerrors.NewInternalError("", "", "internal server error")
    }
    // ...
}


ğŸ“‹ æƒé™æ¨¡å‹å®¡è®¡æŠ¥å‘ŠéªŒè¯ç»“æœ
1ï¸âƒ£ AuthN è¦†ç›–ä¸ç»•è¿‡ - âœ… æŠ¥å‘Šæ­£ç¡®
| é—®é¢˜ | éªŒè¯ç»“æœ | |------|----------| | SkipPaths ç²¾ç¡®åŒ¹é… | âœ… æ­£ç¡® - middleware.go:65 ä½¿ç”¨ m.skipPaths[r.URL.Path] ç²¾ç¡®åŒ¹é… | | é»˜è®¤ SkipPaths | âœ… æ­£ç¡® - /health/live, /health/ready, /metrics | | æ— å¤§å°å†™/å°¾æ–œæ ç»•è¿‡ | âœ… æ­£ç¡® - ç²¾ç¡®åŒ¹é…æ›´ä¸¥æ ¼ |

2ï¸âƒ£ Blocked å­—æ®µä¸ç”Ÿæ•ˆ - âœ… P0 ç¡®è®¤ï¼
// middleware.go:92-98 - åªæ£€æŸ¥ IsActive å’Œ Expires
if !key.IsActive {
    m.writeUnauthorized(w, "api key is inactive")
    return
}
if key.IsExpired() {
    m.writeUnauthorized(w, "api key has expired")
    return
}
// âŒ ç¼ºå°‘: if key.Blocked { ... }
// engine.go:309 - åªæ£€æŸ¥ endUser.IsBlocked()
if resolved.endUser != nil {
    if resolved.endUser.IsBlocked() {
        return llmerrors.NewPermissionError(...)
    }
}
// âŒ ç¼ºå°‘å¯¹ key.Blocked å’Œ team.Blocked çš„æ£€æŸ¥
ç»“è®ºï¼šAPIKey.Blocked å’Œ Team.Blocked å­—æ®µå­˜åœ¨ä½†ä»æœªè¢« enforceï¼

3ï¸âƒ£ ç®¡ç†é¢ AuthZ ç¼ºå¤± - âœ… P0 ç¡®è®¤ï¼
// management.go - ListKeys æ— ä»»ä½•æˆæƒæ£€æŸ¥
func (h *ManagementHandler) ListKeys(w http.ResponseWriter, r *http.Request) {
    // ç›´æ¥æŒ‰ query filter æŸ¥è¯¢ï¼Œfilter ä¸ºç©ºå³å…¨é‡
    filter := auth.APIKeyFilter{...}
    keys, total, err := h.store.ListAPIKeys(r.Context(), filter)
    // âŒ æ—  auth.GetAuthContext() æ£€æŸ¥
    // âŒ æ—  KeyType/Role æ ¡éªŒ
}
æ‰€æœ‰ç®¡ç†ç«¯ç‚¹éƒ½æ²¡æœ‰æˆæƒæ£€æŸ¥ï¼š

GenerateKey - ä»»ä½• key å¯åˆ›å»ºæ–° key
DeleteKey - ä»»ä½• key å¯åˆ é™¤å…¶ä»– key
ListKeys - ä»»ä½• key å¯æšä¸¾æ‰€æœ‰ key
BlockKey/UnblockKey - ä»»ä½• key å¯ block å…¶ä»– key
4ï¸âƒ£ OIDC ä¸ API Key å†²çª - âœ… P1 ç¡®è®¤ï¼
// oidc.go:93-97 - OIDC æ£€æŸ¥å·²æœ‰ AuthContext
if GetAuthContext(r.Context()) != nil {
    next.ServeHTTP(w, r)
    return
}

// middleware.go:57-67 - API Key middleware ä¸æ£€æŸ¥å·²æœ‰ AuthContext
func (m *Middleware) Authenticate(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        if !m.enabled { next.ServeHTTP(w, r); return }
        if m.skipPaths[r.URL.Path] { next.ServeHTTP(w, r); return }
        // âŒ ç¼ºå°‘: if GetAuthContext(r.Context()) != nil { next.ServeHTTP(w, r); return }
        
        // å¼ºåˆ¶è¦æ±‚ API Key
        authHeader := r.Header.Get("Authorization")
        apiKey, err := ParseAuthHeader(authHeader)
        if err != nil {
            m.writeUnauthorized(w, "missing or invalid authorization header")
            return
        }
ç»“è®ºï¼šOIDC æˆåŠŸåï¼ŒAPI Key middleware ä»ä¼šå¼ºåˆ¶è¦æ±‚ API Keyï¼Œå¯¼è‡´ OIDC æ— æ³•ç‹¬ç«‹å·¥ä½œã€‚

5ï¸âƒ£ Invitation X-User-ID ä¼ªé€  - âœ… P1 ç¡®è®¤ï¼
// invitation_endpoints.go:87
createdBy := r.Header.Get("X-User-ID")
if createdBy == "" {
    createdBy = "system"
}
é—®é¢˜ï¼šç›´æ¥ä¿¡ä»»å®¢æˆ·ç«¯æä¾›çš„ X-User-ID headerï¼Œå¯è¢«ä¼ªé€ ã€‚

6ï¸âƒ£ RegenerateKey äº‹åŠ¡é—®é¢˜ - âœ… P1 ç¡®è®¤ï¼
// management.go:501-510
// Delete old key and create new one
if err := h.store.DeleteAPIKey(r.Context(), oldKey.ID); err != nil {
    // å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œæ—§ key å·²åˆ é™¤ä½†æ–° key æœªåˆ›å»º
    return
}
if err := h.store.CreateAPIKey(r.Context(), newKey); err != nil {
    // âŒ æ— äº‹åŠ¡ï¼æ—§ key å·²åˆ é™¤ï¼Œæ–° key åˆ›å»ºå¤±è´¥ = key ä¸¢å¤±
    return
}
7ï¸âƒ£ Schema æ¼‚ç§» - âœ… P0 ç¡®è®¤ï¼
| ä½ç½® | 001_init.sql | postgres.go | é—®é¢˜ | |------|--------------|-------------|------| | users è¡¨ | email | user_email, user_alias | âŒ åˆ—åä¸åŒ¹é… | | usage_logs | api_key_id | api_key | âŒ åˆ—åä¸åŒ¹é… | | api_keys | æ—  blocked åˆ— | æœ‰ blocked å­—æ®µ | âŒ åˆ—ç¼ºå¤± | | api_keys | æ—  organization_id | æœ‰ organization_id | âŒ åˆ—ç¼ºå¤± | | teams | æ—  team_alias, blocked | æœ‰è¿™äº›å­—æ®µ | âŒ åˆ—ç¼ºå¤± |

ç»“è®ºï¼š001_init.sql ä¸ postgres.go ä¸¥é‡ä¸ä¸€è‡´ï¼Œå¯åŠ¨å³æŠ¥é”™ï¼

ğŸ“Š éªŒè¯æ€»ç»“
| ç±»åˆ« | é—®é¢˜ | ä¸¥é‡æ€§ | éªŒè¯ç»“æœ | |------|------|--------|----------| | AuthZ | ç®¡ç†é¢æ— æˆæƒæ£€æŸ¥ | P0 | âœ… ç¡®è®¤ | | AuthZ | Blocked å­—æ®µä¸ç”Ÿæ•ˆ | P0 | âœ… ç¡®è®¤ | | Schema | è¿ç§»è„šæœ¬ä¸ä»£ç æ¼‚ç§» | P0 | âœ… ç¡®è®¤ | | AuthN | OIDC ä¸ API Key å†²çª | P1 | âœ… ç¡®è®¤ | | AuthZ | Invitation X-User-ID å¯ä¼ªé€  | P1 | âœ… ç¡®è®¤ | | äº‹åŠ¡ | RegenerateKey æ— äº‹åŠ¡ | P1 | âœ… ç¡®è®¤ | | æ­»ä»£ç  | RateLimitMiddleware æœªæ¥å…¥ | P2 | âœ… ç¡®è®¤ | | æ­»ä»£ç  | ModelAccessMiddleware æœªæ¥å…¥ | P2 | âœ… ç¡®è®¤ | | æ­»ä»£ç  | RegisterInvitationRoutes æœªè°ƒç”¨ | P2 | âœ… ç¡®è®¤ |

ğŸ”§ ä¿®å¤ä¼˜å…ˆçº§
P0 - ç«‹å³ä¿®å¤
ç®¡ç†é¢ AuthZï¼šæ·»åŠ  RequireManagementAuth middleware

func RequireManagementAuth(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        authCtx := auth.GetAuthContext(r.Context())
        if authCtx == nil || authCtx.APIKey == nil {
            writeUnauthorized(w, "authentication required")
            return
        }
        if authCtx.APIKey.KeyType != auth.KeyTypeManagement {
            writeForbidden(w, "management key required")
            return
        }
        next.ServeHTTP(w, r)
    })
}
Blocked æ£€æŸ¥ï¼šåœ¨ middleware.go:92 åæ·»åŠ 


if key.Blocked {
    m.writeUnauthorized(w, "api key is blocked")
    return
}
Schema ç»Ÿä¸€ï¼šæ›´æ–° 001_init.sql æˆ–åˆ›å»º 002_schema_fix.sql

P1 - æœ¬å‘¨ä¿®å¤
OIDC å…¼å®¹ï¼šAPI Key middleware æ£€æŸ¥å·²æœ‰ AuthContext
Invitation å®‰å…¨ï¼šä» AuthContext è·å– creatorï¼Œä¸ä¿¡ä»» header
RegenerateKey äº‹åŠ¡ï¼šä½¿ç”¨ db.BeginTx() åŒ…è£…


ğŸ“‹ è·¯ç”±é“¾è·¯å®¡è®¡æŠ¥å‘ŠéªŒè¯ç»“æœ
1ï¸âƒ£ RoundRobin Key æ— é™å¢é•¿ - âœ… P0 ç¡®è®¤ï¼
// round_robin_store.go:70 - Redis INCR æ—  TTL
func (r *RedisRoundRobinStore) NextIndex(ctx context.Context, key string, modulo int) (int, error) {
    fullKey := roundRobinKeyPrefix + key  // "llmux:rr:" + model
    value, err := r.client.Incr(ctx, fullKey).Result()
    // âŒ æ—  TTL è®¾ç½®ï¼key æ°¸ä¸è¿‡æœŸ
    return int(idx), nil
}
// round_robin.go:86 - key ç›´æ¥ä½¿ç”¨ç”¨æˆ·ä¼ å…¥çš„ model
func (r *RoundRobinRouter) nextIndex(model string, count int) int {
    if r.rrStore != nil {
        idx, err := r.rrStore.NextIndex(context.Background(), model, count)
        // model æ˜¯ç”¨æˆ·åŸå§‹è¾“å…¥ï¼Œå¯èƒ½æ˜¯ "xxx/gpt-4"
    }
}
æ”»å‡»å‘é‡ï¼š

ç”¨æˆ·å‘é€ model: "attacker1/gpt-4" â†’ Redis key llmux:rr:attacker1/gpt-4
ç”¨æˆ·å‘é€ model: "attacker2/gpt-4" â†’ Redis key llmux:rr:attacker2/gpt-4
é‡å¤ N æ¬¡ â†’ Redis äº§ç”Ÿ N ä¸ªæ°¸ä¸è¿‡æœŸçš„ key
åŒæ—¶æœ¬åœ° sync.Map ä¹Ÿä¼šæ— é™å¢é•¿ï¼š

// round_robin.go:112
func (r *RoundRobinRouter) counterForModel(model string) *atomic.Uint64 {
    actual, _ := r.counters.LoadOrStore(model, counter)
    // sync.Map æ— æ¸…ç†æœºåˆ¶
}
2ï¸âƒ£ Model å‰ç¼€å‰¥ç¦»å¯¼è‡´è·¯ç”±ç»•è¿‡ - âœ… P1 ç¡®è®¤ï¼
// base.go:186-190 - æ‰¾ä¸åˆ°æ—¶å‰¥ç¦»å‰ç¼€ç»§ç»­åŒ¹é…
func (r *BaseRouter) snapshotDeployments(model string) []*ExtendedDeployment {
    deps := r.deployments[model]
    if len(deps) == 0 && strings.Contains(model, "/") {
        if stripped := model[strings.LastIndex(model, "/")+1:]; stripped != "" {
            deps = r.deployments[stripped]  // "xxx/gpt-4" â†’ "gpt-4"
        }
    }
}
é£é™©ï¼š

æ²»ç†/æƒé™æ£€æŸ¥ç”¨åŸå§‹ modelï¼ˆå¦‚ openai/gpt-4ï¼‰
è·¯ç”±ç”¨å‰¥ç¦»åçš„ modelï¼ˆå¦‚ gpt-4ï¼‰
å¯èƒ½å¯¼è‡´"é…ç½®äº† gpt-4 çš„é™æµï¼Œä½†ç”¨æˆ·ä¼  xxx/gpt-4 ç»•è¿‡"
3ï¸âƒ£ Router Stats ä¸²ç§Ÿæˆ· - âœ… P0 ç¡®è®¤ï¼
// redis_stats_store.go:513 - key åªæŒ‰ deploymentIDï¼Œæ— ç§Ÿæˆ·ç»´åº¦
func (r *RedisStatsStore) deploymentKeyPrefix(deploymentID string) string {
    return fmt.Sprintf("%s:{%s}", r.keyPrefix, deploymentID)
    // ç»“æœ: "llmux:router:stats:{dep-uuid}"
    // âŒ æ—  tenant/org/team ç»´åº¦
}
é—®é¢˜ï¼š

æ‰€æœ‰ç§Ÿæˆ·å…±äº«åŒä¸€æ‰¹ deployment çš„ç»Ÿè®¡
ç§Ÿæˆ· A çš„å¤±è´¥ä¼šå½±å“ç§Ÿæˆ· B çš„è·¯ç”±å†³ç­–
æ¶æ„ç§Ÿæˆ·å¯é€šè¿‡åˆ¶é€ å¤±è´¥æ¨åŠ¨å…¨å±€ cooldown
4ï¸âƒ£ å†·å´æ—  Half-Open æ¢æµ‹ - âœ… P1 ç¡®è®¤ï¼
// base.go:287 - åªæ£€æŸ¥æ˜¯å¦åœ¨å†·å´æœŸ
func (r *BaseRouter) getHealthyDeployments(...) []*ExtendedDeployment {
    for _, d := range deployments {
        if stats == nil || now.After(stats.CooldownUntil) {
            healthy = append(healthy, d)
        }
    }
    // âŒ å†·å´åˆ°æœŸåç›´æ¥æ¢å¤ï¼Œæ—  half-open æ¢æµ‹
}
é£é™©ï¼šå†·å´åˆ°æœŸåæ‰€æœ‰å®ä¾‹åŒæ—¶æ¢å¤è¯·æ±‚ï¼Œå¯èƒ½é€ æˆ"æƒŠç¾¤æ•ˆåº”"ã€‚

5ï¸âƒ£ CircuitBreaker æ­»ä»£ç  - âœ… ç¡®è®¤ï¼
æŠ¥å‘Šæåˆ° circuitbreaker.go æ˜¯å‚è€ƒå®ç°æœªæ¥å…¥ç”Ÿäº§ã€‚è®©æˆ‘éªŒè¯ï¼š

Searched workspace
éªŒè¯ CircuitBreaker æ˜¯å¦è¢«ç”Ÿäº§ä»£ç ä½¿ç”¨
Searched workspace
éªŒè¯ circuitbreaker æ˜¯å¦è¢«ç”Ÿäº§ä»£ç ä½¿ç”¨
CircuitBreaker ç›¸å…³ä»£ç ç¡®å®ä¸å­˜åœ¨æˆ–æœªè¢«ä½¿ç”¨ï¼ŒæŠ¥å‘Šæ­£ç¡®ã€‚

ğŸ“Š è·¯ç”±é“¾è·¯å®¡è®¡æŠ¥å‘ŠéªŒè¯æ€»ç»“
| ç±»åˆ« | é—®é¢˜ | ä¸¥é‡æ€§ | éªŒè¯ç»“æœ | |------|------|--------|----------| | Redis Key | RoundRobin key æ—  TTL + ç”¨æˆ·å¯æ§ model | P0 | âœ… ç¡®è®¤ | | Redis Key | æœ¬åœ° sync.Map æ— é™å¢é•¿ | P0 | âœ… ç¡®è®¤ | | ç§Ÿæˆ·éš”ç¦» | Router Stats æ— ç§Ÿæˆ·ç»´åº¦ï¼Œä¸²ç§Ÿæˆ· | P0 | âœ… ç¡®è®¤ | | ç§Ÿæˆ·éš”ç¦» | æ¶æ„ç§Ÿæˆ·å¯æŠ•æ¯’ cooldown | P0 | âœ… ç¡®è®¤ | | è·¯ç”±ç»•è¿‡ | Model å‰ç¼€å‰¥ç¦»å¯èƒ½ç»•è¿‡æ²»ç† | P1 | âœ… ç¡®è®¤ | | ç¨³å®šæ€§ | å†·å´æ—  half-open æ¢æµ‹ï¼Œå¯èƒ½æƒŠç¾¤ | P1 | âœ… ç¡®è®¤ | | Metrics | ç”¨æˆ·å¯æ§ model å¯¼è‡´ label é«˜åŸºæ•° | P1 | âœ… ç¡®è®¤ | | æ­»ä»£ç  | CircuitBreaker æœªæ¥å…¥ç”Ÿäº§ | P2 | âœ… ç¡®è®¤ï¼ˆä»£ç ä¸å­˜åœ¨ï¼‰ |

ğŸ”§ ä¿®å¤å»ºè®®
P0 - ç«‹å³ä¿®å¤
1. RoundRobin Key TTL + è§„èŒƒåŒ–

// round_robin_store.go - ä¿®å¤
func (r *RedisRoundRobinStore) NextIndex(ctx context.Context, key string, modulo int) (int, error) {
    // è§„èŒƒåŒ– keyï¼šå»é™¤å‰ç¼€ï¼Œåªä¿ç•™ canonical model
    canonicalKey := canonicalizeModel(key)
    fullKey := roundRobinKeyPrefix + canonicalKey
    
    pipe := r.client.Pipeline()
    incr := pipe.Incr(ctx, fullKey)
    pipe.Expire(ctx, fullKey, 24*time.Hour)  // æ·»åŠ  TTL
    _, err := pipe.Exec(ctx)
    if err != nil {
        return 0, err
    }
    return int((incr.Val() - 1) % int64(modulo)), nil
}

func canonicalizeModel(model string) string {
    if idx := strings.LastIndex(model, "/"); idx >= 0 {
        return model[idx+1:]
    }
    return model
}
2. æœ¬åœ° sync.Map å®šæœŸæ¸…ç†

// round_robin.go - æ·»åŠ æ¸…ç†æœºåˆ¶
func (r *RoundRobinRouter) StartCleanup(interval time.Duration) {
    go func() {
        ticker := time.NewTicker(interval)
        for range ticker.C {
            r.counters.Range(func(key, _ any) bool {
                // æ¸…ç†ä¸æ´»è·ƒçš„ model è®¡æ•°å™¨
                r.counters.Delete(key)
                return true
            })
        }
    }()
}
3. Router Stats ç§Ÿæˆ·éš”ç¦»

// redis_stats_store.go - æ·»åŠ ç§Ÿæˆ·ç»´åº¦
type RedisStatsStore struct {
    // ...
    tenantID string  // æ–°å¢
}

func (r *RedisStatsStore) deploymentKeyPrefix(deploymentID string) string {
    if r.tenantID != "" {
        return fmt.Sprintf("%s:%s:{%s}", r.keyPrefix, r.tenantID, deploymentID)
    }
    return fmt.Sprintf("%s:{%s}", r.keyPrefix, deploymentID)
}
P1 - æœ¬å‘¨ä¿®å¤
4. Model è§„èŒƒåŒ–ç»Ÿä¸€

// åœ¨è·¯ç”±å’Œæ²»ç†å…¥å£ç»Ÿä¸€è§„èŒƒåŒ– model
func normalizeModel(model string) string {
    // å»é™¤ provider å‰ç¼€
    if idx := strings.LastIndex(model, "/"); idx >= 0 {
        return model[idx+1:]
    }
    return model
}
5. Half-Open æ¢æµ‹


// base.go - æ·»åŠ  half-open çŠ¶æ€
func (r *BaseRouter) getHealthyDeployments(...) []*ExtendedDeployment {
    for _, d := range deployments {
        if stats == nil || now.After(stats.CooldownUntil) {
            healthy = append(healthy, d)
        } else if r.shouldProbe(stats) {
            // Half-open: å…è®¸å°‘é‡æ¢æµ‹è¯·æ±‚
            healthy = append(healthy, d)
        }
    }
}

func (r *BaseRouter) shouldProbe(stats *router.DeploymentStats) bool {
    // å†·å´æœŸè¿‡åŠåï¼Œä»¥ 10% æ¦‚ç‡å…è®¸æ¢æµ‹
    elapsed := time.Since(stats.CooldownUntil.Add(-r.config.CooldownPeriod))
    if elapsed > r.config.CooldownPeriod/2 {
        return r.randFloat64() < 0.1
    }
    return false
}


ğŸ“‹ ä¸Šæ¸¸è¯·æ±‚é“¾è·¯å®¡è®¡æŠ¥å‘ŠéªŒè¯ç»“æœ
1ï¸âƒ£ SSRF é£é™© - âœ… P0 ç¡®è®¤ï¼
BaseURL æ— ä»»ä½•æ ¡éªŒï¼š

// openailike.go:140 - ç›´æ¥å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œæ—  scheme/host æ ¡éªŒ
url := strings.TrimSuffix(p.baseURL, "/") + endpoint
httpReq, err := http.NewRequestWithContext(ctx, http.MethodPost, url, bytes.NewReader(body))
é»˜è®¤ localhost provider å­˜åœ¨ï¼š

// ollama.go:11
DefaultBaseURL = "http://localhost:11434/v1"

// litellm_compat.go - å¤šä¸ª localhost é»˜è®¤å€¼
"lemonade":  {DefaultBaseURL: "http://localhost:8000"},
"llamafile": {DefaultBaseURL: "http://127.0.0.1:8080/v1"},
"ragflow":   {DefaultBaseURL: "http://localhost:9380"},
é£é™©ï¼šå¦‚æœé…ç½®é¢è¢«ä¸å¯ä¿¡æ–¹å½±å“ï¼ˆé…ç½®æ–‡ä»¶/çƒ­é‡è½½/ç®¡ç† APIï¼‰ï¼Œå¯æ‰“å†…ç½‘ã€‚

2ï¸âƒ£ URL æ‹¼æ¥æ³¨å…¥ - âœ… P1 ç¡®è®¤ï¼
Azure - deploymentName æœª escapeï¼š

// azure.go:77 - req.Model ç›´æ¥æ’å…¥ URL path
url := fmt.Sprintf("%s/openai/deployments/%s/chat/completions?api-version=%s",
    strings.TrimSuffix(p.baseURL, "/"), deploymentName, p.apiVersion)
// âŒ deploymentName æœª url.PathEscape()
Gemini - API key æœª escapeï¼š

// gemini.go:129 - token ç›´æ¥æ‹¼å…¥ query
url := fmt.Sprintf("%s/%s/models/%s:%s?key=%s",
    strings.TrimSuffix(p.baseURL, "/"), p.apiVersion, req.Model, action, token)
// âŒ token æœª url.QueryEscape()ï¼Œè‹¥å« &/+ ä¼šç ´å query è¯­ä¹‰
3ï¸âƒ£ Header å®‰å…¨ - âš ï¸ ä½é£é™©ä½†éœ€æ³¨æ„
å¥½çš„æ–¹é¢ï¼šæœªå‘ç°ç”¨æˆ· header é€ä¼ åˆ°ä¸Šæ¸¸

// openailike.go:155-174 - header æ¥è‡ªé…ç½®ï¼Œä¸æ˜¯ç”¨æˆ·è¯·æ±‚
httpReq.Header.Set(apiKeyHeader, apiKeyPrefix+token)
for k, v := range p.info.ExtraHeaders {
    httpReq.Header.Set(k, v)
}
for k, v := range p.headers {
    httpReq.Header.Set(k, v)
}
éœ€æ³¨æ„ï¼šcfg.Headers å¯æ³¨å…¥ä»»æ„ headerï¼Œæ—  denylist

4ï¸âƒ£ é…ç½®æœªç”Ÿæ•ˆ - âœ… P1 ç¡®è®¤ï¼
// main.go:420-438 - buildClientOptions åªä¼ äº†éƒ¨åˆ†å­—æ®µ
pCfg := llmux.ProviderConfig{
    Name:    provCfg.Name,
    Type:    provCfg.Type,
    APIKey:  provCfg.APIKey,
    BaseURL: provCfg.BaseURL,
    Models:  provCfg.Models,
}
// âŒ ç¼ºå°‘: Timeout, MaxConcurrent, Headers
config.go å®šä¹‰äº†ä½†æœªä¼ é€’ï¼š

providers[].timeout - æœªç”Ÿæ•ˆ
providers[].max_concurrent - æœªç”Ÿæ•ˆ
providers[].headers - æœªç”Ÿæ•ˆ
5ï¸âƒ£ LiteLLM Compat å¼ºåˆ¶èƒ½åŠ› - âœ… P1 ç¡®è®¤ï¼
// litellm_compat.go:38-42 - å¼ºåˆ¶è®¾ä¸º true
if !defaults.SupportsStreaming {
    defaults.SupportsStreaming = true
}
if !defaults.SupportsEmbedding {
    defaults.SupportsEmbedding = true
}
é£é™©ï¼šæŸäº› provider å®é™…ä¸æ”¯æŒ embeddingï¼Œä½†ä»£ç å¼ºåˆ¶æ ‡è®°ä¸ºæ”¯æŒï¼Œå¯¼è‡´è¿è¡Œæ—¶å¤±è´¥ã€‚

6ï¸âƒ£ è¶…æ—¶/é‡è¯•æ”¾å¤§ - âš ï¸ ä¸­é£é™©
é‡è¯•æ¬¡æ•°ï¼šé»˜è®¤ 3 æ¬¡é‡è¯• = æœ€å¤š 4 æ¬¡ä¸Šæ¸¸è°ƒç”¨

æµå¼æ¢å¤æ—  backoffï¼š

// stream.go - tryRecover ç›´æ¥é‡è¯•ï¼Œæ—  backoff
func (s *StreamReader) tryRecover(originalErr error) (*types.StreamChunk, error) {
    // ç›´æ¥é‡è¯•ï¼Œæ—  backoff
    resp, err := s.client.httpClient.Do(httpReq)
}
å¹¶å‘ä¸Šé™æœªç”Ÿæ•ˆï¼šmax_concurrent é…ç½®æœªä¼ å…¥ llmux

ğŸ“Š éªŒè¯æ€»ç»“
| ç±»åˆ« | é—®é¢˜ | ä¸¥é‡æ€§ | éªŒè¯ç»“æœ | |------|------|--------|----------| | SSRF | BaseURL æ—  scheme/host/IP æ ¡éªŒ | P0 | âœ… ç¡®è®¤ | | SSRF | é»˜è®¤ localhost provider | P0 | âœ… ç¡®è®¤ | | URL æ³¨å…¥ | Azure deploymentName æœª escape | P1 | âœ… ç¡®è®¤ | | URL æ³¨å…¥ | Gemini API key æœª escape | P1 | âœ… ç¡®è®¤ | | é…ç½® | timeout/max_concurrent/headers æœªç”Ÿæ•ˆ | P1 | âœ… ç¡®è®¤ | | èƒ½åŠ› | LiteLLM compat å¼ºåˆ¶ streaming/embedding | P1 | âœ… ç¡®è®¤ | | é‡è¯• | æµå¼æ¢å¤æ—  backoff | P1 | âœ… ç¡®è®¤ | | Header | cfg.Headers æ—  denylist | P2 | âœ… ç¡®è®¤ |

ğŸ”§ ä¿®å¤å»ºè®®
P0 - ç«‹å³ä¿®å¤
1. BaseURL å®‰å…¨æ ¡éªŒ

// pkg/provider/validation.go - æ–°å¢
func ValidateBaseURL(rawURL string, allowInsecure bool) error {
    u, err := url.Parse(rawURL)
    if err != nil {
        return fmt.Errorf("invalid URL: %w", err)
    }
    
    // å¿…é¡»æœ‰ scheme
    if u.Scheme == "" {
        return errors.New("URL must have scheme")
    }
    
    // é»˜è®¤åªå…è®¸ https
    if !allowInsecure && u.Scheme != "https" {
        return errors.New("only https allowed (set allow_insecure to override)")
    }
    
    // ç¦æ­¢ userinfo
    if u.User != nil {
        return errors.New("URL must not contain userinfo")
    }
    
    // ç¦æ­¢ loopback/private IPï¼ˆé™¤éæ˜¾å¼å…è®¸ï¼‰
    if !allowInsecure {
        host := u.Hostname()
        if isPrivateOrLoopback(host) {
            return fmt.Errorf("private/loopback address not allowed: %s", host)
        }
    }
    
    return nil
}
P1 - æœ¬å‘¨ä¿®å¤
2. URL å®‰å…¨æ„é€ 

// azure.go - ä¿®å¤
import "net/url"

func (p *Provider) BuildRequest(...) (*http.Request, error) {
    baseURL, _ := url.Parse(p.baseURL)
    baseURL.Path = path.Join(baseURL.Path, "openai/deployments", 
        url.PathEscape(deploymentName), "chat/completions")
    q := baseURL.Query()
    q.Set("api-version", p.apiVersion)
    baseURL.RawQuery = q.Encode()
    // ...
}

// gemini.go - ä¿®å¤
func (p *Provider) BuildRequest(...) (*http.Request, error) {
    baseURL, _ := url.Parse(p.baseURL)
    baseURL.Path = path.Join(baseURL.Path, p.apiVersion, "models", 
        url.PathEscape(req.Model)+":"+action)
    q := baseURL.Query()
    q.Set("key", token)  // url.Values è‡ªåŠ¨ escape
    baseURL.RawQuery = q.Encode()
    // ...
}
3. é…ç½®ä¼ é€’ä¿®å¤


// main.go - buildClientOptions è¡¥å…¨
pCfg := llmux.ProviderConfig{
    Name:          provCfg.Name,
    Type:          provCfg.Type,
    APIKey:        provCfg.APIKey,
    BaseURL:       provCfg.BaseURL,
    Models:        provCfg.Models,
    Timeout:       provCfg.Timeout,       // æ–°å¢
    MaxConcurrent: provCfg.MaxConcurrent, // æ–°å¢
    Headers:       provCfg.Headers,       // æ–°å¢
}
4. æµå¼æ¢å¤ backoff

// stream.go - tryRecover æ·»åŠ  backoff
func (s *StreamReader) tryRecover(originalErr error) (*types.StreamChunk, error) {
    // æ·»åŠ  backoff
    backoff := time.Duration(s.retryCount) * 100 * time.Millisecond
    if backoff > time.Second {
        backoff = time.Second
    }
    select {
    case <-time.After(backoff):
    case <-s.ctx.Done():
        return nil, s.ctx.Err()
    }
    // ... ç»§ç»­é‡è¯•
}


ç»“è®ºæ‘˜è¦ï¼ˆåŸºçº¿ ed4f361ï¼‰

ç›®å‰ç½‘å…³å®é™…å¯ç”¨çš„â€œå“åº”ç¼“å­˜â€èµ°çš„æ˜¯ llmux.Client å†…ç½®ç¼“å­˜ï¼škey ä¸åŒ…å«ç§Ÿæˆ·ä¿¡æ¯ï¼Œä¸”åªè¦†ç›–å°‘é‡è¯·æ±‚å­—æ®µï¼Œå¹¶ä½¿ç”¨éåŠ å¯†çš„ FNV64 å“ˆå¸Œï¼›åœ¨å¤šç§Ÿæˆ·/å…±äº« Redis åœºæ™¯ä¸‹å­˜åœ¨è·¨ç§Ÿæˆ·å‘½ä¸­ä¸å¯æ„é€ â€œé”®å†²çª/æŠ•æ¯’â€çš„ç°å®é£é™©ï¼ˆå°¤å…¶æ˜¯é—æ¼å­—æ®µå¯¼è‡´çš„â€œç­‰ä»· keyâ€ï¼‰ã€‚è¯æ®ï¼šclient.go (line 263), client.go (line 1455), client.go (line 1484), config.distributed.yaml (line 48)ã€‚
ä»“åº“é‡Œè¿˜æœ‰å¦ä¸€å¥— internal/cache/*ï¼ˆå« namespaceã€SHA-256 keygenã€semantic cacheï¼‰ä»¥åŠ cache.go çš„æ’ä»¶ç¼“å­˜ï¼Œä½†å®ƒä»¬æœªæ¥å…¥ç½‘å…³ä¸»é“¾è·¯ï¼Œå±äºâ€œä¼ªå®ç°/æœªè½åœ°â€çš„ç¼“å­˜è·¯å¾„ã€‚è¯æ®ï¼šcache_options.go (line 16), factory.go (line 85), cache.go (line 68)ã€‚
Cache è¯»å†™é“¾è·¯å›¾ï¼ˆå®é™…è¿è¡Œè·¯å¾„ï¼‰

ç½‘å…³ï¼šmain.go åˆå§‹åŒ– cache options -> llmux.New(...) -> å¤„ç†è¯·æ±‚æ—¶è°ƒç”¨ Client.ChatCompletionã€‚è¯æ®ï¼šmain.go (line 455), cache_options.go (line 64)
Client.ChatCompletion å†…éƒ¨ï¼š
PreHooksï¼ˆå¯ short-circuitï¼‰â†’ rate limit â†’ å†…ç½® cache Getï¼ˆå‘½ä¸­åˆ™ç»•è¿‡ provider è°ƒç”¨ï¼‰ â†’ router/provider â†’ PostHooks â†’ å†…ç½® cache Setã€‚è¯æ®ï¼šclient.go (line 222), client.go (line 243), client.go (line 263), client.go (line 308)
æ’ä»¶ short-circuit è¯­ä¹‰æœ¬èº«å­˜åœ¨ï¼Œä½†â€œcache æ’ä»¶â€æœªè¢«æ³¨å†Œä½¿ç”¨ã€‚è¯æ®ï¼špipeline.go (line 190), cache.go (line 90)
Key è§„èŒƒå®¡è®¡ï¼ˆç°çŠ¶ vs. ç§Ÿæˆ·éš”ç¦»ï¼‰

å®é™…å†…ç½®ç¼“å­˜ keyï¼ˆç½‘å…³/åº“æ¨¡å¼éƒ½ä¼šèµ°ï¼‰ï¼šllmux:%xï¼Œå…¶ä¸­ %x æ˜¯å¯¹ {model,messages,temperature,max_tokens} JSON çš„ FNV64ã€‚è¯æ®ï¼šclient.go (line 1463), client.go (line 1481), client.go (line 1485)
è¯·æ±‚ä½“å…³é”®å­—æ®µè¦†ç›–ä¸è¶³ï¼šChatRequest è¿˜æœ‰ TopP/Tools/ToolChoice/ResponseFormat/Stop/N/PresencePenalty/FrequencyPenalty/Tags/Extra/... ç­‰ä¼šå½±å“å“åº”çš„å­—æ®µï¼Œä½† æœªè¿›å…¥ keyDataã€‚è¯æ®ï¼šrequest.go (line 9), client.go (line 1463)
Redis â€œnamespaceâ€ä»…æ˜¯å…¨å±€å‰ç¼€ï¼Œä¸æ˜¯ç§Ÿæˆ·éš”ç¦»ï¼šnamespace + ":" + keyï¼Œé»˜è®¤ config ç”¨ llmuxï¼Œå¯¼è‡´ Redis å®é™… key å½¢å¦‚ llmux:llmux:<fnv>ï¼ˆåŒå‰ç¼€ï¼‰ã€‚è¯æ®ï¼šredis.go (line 139), cache_options.go (line 84), client.go (line 1481)
å¿…é¡»å›ç­”ï¼ˆå¸¦è¯æ®ï¼‰
cache key æ˜¯å¦åŒ…å«ç§Ÿæˆ·/model/è¯·æ±‚å…³é”®å­—æ®µï¼Ÿæ˜¯å¦è·¨ç§Ÿæˆ·å‘½ä¸­ï¼Ÿ
ç§Ÿæˆ·ç»´åº¦ï¼šä¸åŒ…å«ã€‚å®é™… key åªå– Model/Messages/Temperature/MaxTokensï¼Œæ²¡æœ‰ api key/team/orgã€‚è¯æ®ï¼šclient.go (line 1463), client.go (line 1481)ã€‚
å¤šç§Ÿæˆ·ä¸Šä¸‹æ–‡åœ¨è¯·æ±‚é‡Œæ˜¯å­˜åœ¨çš„ï¼ˆå¹¶ç”¨äº rate limitï¼‰ï¼Œä½†ç¼“å­˜æ²¡ç”¨ï¼šauth.GetAuthContext(ctx).APIKey.IDã€‚è¯æ®ï¼šclient.go (line 961), types.go (line 186)ã€‚
ä¼šè·¨ç§Ÿæˆ·å‘½ä¸­å¯¼è‡´æ³„éœ²çš„æ¡ä»¶ï¼šå…±äº«åŒä¸€ cache backendï¼ˆå°¤å…¶æ˜¯ config.distributed.yaml é»˜è®¤å¯ç”¨ dual ä¸” Redis å…±äº«ï¼‰+ key ä¸å¸¦ç§Ÿæˆ· â†’ ä¸åŒç§Ÿæˆ·å¯å‘½ä¸­åŒä¸€ keyã€‚è¯æ®ï¼šconfig.distributed.yaml (line 48), cache_options.go (line 64), client.go (line 266)ã€‚
è¯·æ±‚å…³é”®å­—æ®µè¦†ç›–ï¼šä¸è¶³ï¼ˆä¸Šé¢åˆ—å‡ºçš„å­—æ®µå‡ç¼ºå¤±ï¼‰ï¼Œå› æ­¤å³ä¾¿åŒç§Ÿæˆ·ä¹Ÿå¯èƒ½â€œé”™å‘½ä¸­â€ã€‚è¯æ®ï¼šrequest.go (line 9), client.go (line 1463)ã€‚
cache æŠ•æ¯’ï¼šèƒ½å¦æ„é€  key å†²çªï¼Ÿèƒ½å¦ç¼“å­˜é”™è¯¯/æ•æ„Ÿå“åº”ï¼Ÿ
å¯æ„é€ â€œé€»è¾‘å†²çªâ€ï¼ˆæ— éœ€å“ˆå¸Œç¢°æ’ï¼‰ï¼šå› ä¸º key å¿½ç•¥äº† TopP/Tools/ToolChoice/ResponseFormat/Stop/N/.../Extraï¼Œæ”»å‡»è€…å¯ç”¨â€œè¢«å¿½ç•¥å­—æ®µå·®å¼‚â€çš„è¯·æ±‚ A å…ˆå†™å…¥ç¼“å­˜ï¼Œå†è®©ç›®æ ‡è¯·æ±‚ B å‘½ä¸­åŒ keyï¼Œå½¢æˆæŠ•æ¯’/é”™å›åŒ…ã€‚è¯æ®ï¼šclient.go (line 1463), request.go (line 9)ã€‚
å“ˆå¸Œå±‚é¢æ›´ç³Ÿï¼šFNV64 éåŠ å¯†ï¼Œå­˜åœ¨è¢«åˆ»æ„å¯»æ‰¾ç¢°æ’çš„å¯èƒ½ï¼ˆè¿œæ¯” SHA-256 å¼±ï¼‰ï¼Œæ”¾å¤§æŠ•æ¯’é£é™©ã€‚è¯æ®ï¼šclient.go (line 1484)ã€‚
é”™è¯¯å“åº”ç¼“å­˜ï¼šå†…ç½®ç¼“å­˜åªåœ¨ finalErr == nil && finalResp != nil æ—¶å†™å…¥ï¼Œæ‰€ä»¥â€œæ˜¾å¼ errorâ€ä¸ä¼šç¼“å­˜ï¼›ä½†â€œ200 å†…å«æ•æ„Ÿå†…å®¹/ä¸šåŠ¡ä¸å¸Œæœ›ç¼“å­˜çš„å“åº”â€ä»ä¼šè¢«ç¼“å­˜ã€‚è¯æ®ï¼šclient.go (line 308)ã€‚
æ’ä»¶ç¼“å­˜ï¼ˆæœªæ¥å…¥ï¼‰ä½¿ç”¨ SHA-256 ä¸”ä¹Ÿä¸å«ç§Ÿæˆ·ï¼šdefaultKeyFuncã€‚è¯æ®ï¼šcache.go (line 169)ã€‚
Redis cacheï¼šTTLã€æ·˜æ±°ã€scan/keys é£é™©ã€æ— é™å¢é•¿é£é™©
TTLï¼šå†™å…¥æ—¶å§‹ç»ˆå¸¦ TTLï¼ˆttl<=0 å›é€€åˆ° defaultTTLï¼Œé»˜è®¤ 1hï¼Œä¸” server config å¸¸è®¾ ttl: 1hï¼‰ã€‚è¯æ®ï¼šredis.go (line 165), redis.go (line 75), config.distributed.yaml (line 52), cache_options.go (line 92)ã€‚
æ·˜æ±°ï¼šä»£ç ä¸é…ç½® Redis å†…å­˜ç­–ç•¥ï¼ˆä¾èµ– Redis è¿ç»´ä¾§ maxmemory-policyï¼‰ï¼›åº”ç”¨ä¾§ä¸»è¦é  TTL æ§åˆ¶ä½“é‡ã€‚è¯æ®ï¼šredis.go (line 165)ã€‚
scan/keys é£é™©ï¼šå“åº”ç¼“å­˜å®ç°æœªä½¿ç”¨ KEYS/SCANï¼ˆéƒ½æ˜¯ç‚¹æŸ¥ GET/SET/DEL/MGETï¼‰ï¼›ä½†ä¹Ÿæ„å‘³ç€â€œå…¨é‡æ¸…ç©º/æŒ‰ç§Ÿæˆ·æ‰¹é‡å¤±æ•ˆâ€ç›®å‰æ²¡æœ‰å®‰å…¨çš„å†…å»ºæœºåˆ¶ï¼Œåç»­è‹¥å®ç°å¾ˆå¯èƒ½å¼•å…¥ SCAN é£é™©ã€‚è¯æ®ï¼šredis.go (line 147)ã€‚
æ— é™å¢é•¿é£é™©ï¼šå“åº”ç¼“å­˜å†™å…¥éƒ½å¸¦ TTLï¼Œå› æ­¤â€œä¸¥æ ¼æ„ä¹‰çš„æ— é™å¢é•¿â€ä¸»è¦æ¥è‡ª TTL é…ç½®è¿‡å¤§/é«˜ QPSï¼›æ­¤å¤– namespace æ˜¯å…¨å±€å‰ç¼€ï¼Œä¸åŒºåˆ†ç§Ÿæˆ·ï¼Œå¢åŠ è·¨ç¯å¢ƒ/è·¨ç”¨é€”é”®ç©ºé—´æ··æ‚é£é™©ã€‚è¯æ®ï¼šredis.go (line 139), config.distributed.yaml (line 51)ã€‚
ä¸ observabilityï¼šcache_hit æŒ‡æ ‡/æ—¥å¿—æ˜¯å¦æ³„éœ²è¯·æ±‚å†…å®¹ï¼Ÿ
Prometheus ç¼“å­˜æŒ‡æ ‡ label ä»… cache_type, modelï¼Œä¸å« messages/promptã€‚è¯æ®ï¼šinternal.go (line 60), client.go (line 1420)ã€‚
å†…ç½®ç¼“å­˜å‘½ä¸­æ—¥å¿—åªæ‰“å° modelï¼ˆä¸å« key/promptï¼‰ã€‚è¯æ®ï¼šclient.go (line 1431)ã€‚
æ’ä»¶ä½“ç³»é‡Œç¡®å®å­˜åœ¨ cache_hit/cache_key çš„çº¦å®šä¸æ—¥å¿—ï¼Œä½†ç›®å‰ç½‘å…³å¹¶æœªå¡«å…… StandardLoggingPayload.CacheHit/CacheKeyï¼Œusage log ä¹Ÿå†™æ­» CacheHit: nilï¼Œå› æ­¤ä¸ä¼šæŠŠç¼“å­˜ key/prompt é€šè¿‡â€œcache_hit å­—æ®µâ€å¤–æ³„ï¼›ä¸è¿‡ observability payload æœ¬èº«åŒ…å« Messagesï¼ˆæ˜¯å¦å¤–å‘å–å†³äºå„ callback çš„ masking é…ç½®ï¼‰ã€‚è¯æ®ï¼šcallback.go (line 78), client_handler.go (line 1007), client_handler.go (line 701)ã€‚
è‹¥æœªæ¥å¯ç”¨æ’ä»¶ç¼“å­˜ï¼šæ’ä»¶ä¼š ctx.Set("cache_key", key) å¹¶åœ¨ debug æ—¥å¿—æ‰“å° keyï¼ˆhashï¼‰ï¼Œå­˜åœ¨â€œå¯å…³è”è¯·æ±‚â€çš„æ³„éœ²é¢ã€‚è¯æ®ï¼šcache.go (line 110), cache.go (line 113)ã€‚
æ˜¯å¦å­˜åœ¨ä¼ªå®ç°ï¼ˆé»˜è®¤ä¸å¯ç”¨/æ²¡æ¥å…¥ handlerï¼‰ï¼Ÿæ€ä¹ˆè¯æ˜ï¼Ÿ
internal/cache/*ï¼ˆå« Handler/KeyGenerator/Semanticï¼‰åœ¨ä»“åº“ä¸­å­˜åœ¨ï¼Œä½†ç½‘å…³å¯ç”¨ç¼“å­˜èµ°çš„æ˜¯ cache_options.go â†’ llmux.WithCache(...)ï¼ˆä½¿ç”¨ caches/*ï¼‰ï¼Œè€Œé cache.NewCacheHandlerã€‚è¯æ®ï¼šcache_options.go (line 64), factory.go (line 85)ã€‚
cache.go çš„ NewCachePlugin ä»…å®šä¹‰ã€æ— ä»»ä½•æ³¨å†Œ/è°ƒç”¨ç‚¹ï¼ˆä»“åº“å†…åªæœ‰å®šä¹‰å¤„ï¼‰ï¼Œä¸” client.go æ˜ç¡®å†™äº†â€œç†æƒ³ä¸Š cache åº”è¯¥æ˜¯ pluginï¼Œä½†è¿™é‡Œä¿ç•™å†…ç½®ç¼“å­˜â€ã€‚è¯æ®ï¼šcache.go (line 68), client.go (line 263)ã€‚
â€œsemantic cacheâ€åœ¨å…¬å…± API é‡Œæœ‰ç±»å‹å¸¸é‡å¯¼å‡ºï¼Œä½† public factory caches/ ä¸æ”¯æŒ TypeSemanticï¼Œç½‘å…³ config CacheConfig.Type ä¹Ÿä»…æŒ‰ local/redis/dual åˆ†æ”¯åˆ›å»ºã€‚è¯æ®ï¼šfactory.go (line 16), llmux.go (line 205), cache_options.go (line 27)ã€‚
é£é™©æ¸…å•ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
P0 è·¨ç§Ÿæˆ·æ•°æ®éš”ç¦»å¤±è´¥ï¼šç¼“å­˜ key ä¸å« api key/team/orgï¼Œå…±äº« cache æ—¶å¯è·¨ç§Ÿæˆ·å‘½ä¸­ï¼ˆå°¤å…¶ config.distributed.yaml é»˜è®¤å¯ç”¨ï¼‰ã€‚è¯æ®ï¼šclient.go (line 1463), config.distributed.yaml (line 48)ã€‚
P0 å¯æŠ•æ¯’/é”™å›åŒ…ï¼škey è¦†ç›–å­—æ®µè¿‡å°‘ï¼ˆå¿½ç•¥ tool/stop/top_p/response_format/extra ç­‰ï¼‰ï¼Œæ”»å‡»è€…å¯ç”¨â€œå¿½ç•¥å­—æ®µå·®å¼‚â€åˆ¶é€ åŒ keyï¼›ä¸” FNV64 è¿›ä¸€æ­¥é™ä½æŠ—ç¢°æ’æ€§ã€‚è¯æ®ï¼šclient.go (line 1463), client.go (line 1484), request.go (line 9)ã€‚
P1 Redis é”®ç©ºé—´æ··æ‚ï¼šå…¨å±€ namespace ä»…å‰ç¼€ï¼Œä¸åŒºåˆ† tenant/envï¼›ä¸”å¯èƒ½å½¢æˆ llmux:llmux: åŒå‰ç¼€ï¼Œå¢åŠ è¿ç»´æ’éšœä¸æ¸…ç†å¤æ‚åº¦ã€‚è¯æ®ï¼šclient.go (line 1481), redis.go (line 139)ã€‚
P2 ä¼ªå®ç°å¯¼è‡´â€œçœ‹ä¼¼æ”¯æŒ tenant namespace/semantic cacheï¼Œä½†å®é™…æœªç”Ÿæ•ˆâ€ï¼šæœªæ¥æ¥å…¥æ—¶è‹¥ç›´æ¥å…è®¸ç”¨æˆ·æ§åˆ¶ namespace/ttlï¼ˆParseCacheControlï¼‰ï¼Œå°†å¼•å…¥æ–°çš„è¶Šæƒ/æŒä¹…åŒ–é£é™©ã€‚è¯æ®ï¼šhandler.go (line 225)ã€‚
ä¿®å¤å»ºè®®ï¼ˆå¯éªŒè¯ï¼‰
ç»Ÿä¸€å¹¶å‡çº§ key è§„èŒƒï¼šåœ¨ Client.generateCacheKey ä¸­å¼•å…¥ ç§Ÿæˆ· scopeï¼ˆæ¨èé»˜è®¤ authCtx.APIKey.IDï¼Œå¯é€‰ team/orgï¼‰+ å®Œæ•´ã€å¯æ§çš„è¯·æ±‚å­—æ®µé›†åˆï¼ˆè‡³å°‘è¦†ç›– TopP/Tools/ToolChoice/ResponseFormat/Stop/N/*Penalty/Tags/Extraï¼‰+ SHA-256ï¼ˆæ›¿æ¢ FNV64ï¼‰ã€‚è¯æ®å®šä½ï¼šclient.go (line 1455), client.go (line 1484)ã€‚
ç§Ÿæˆ·éš”ç¦»ç­–ç•¥ï¼šredis namespace ä½œä¸ºå…¨å±€å‰ç¼€ï¼ˆenv/appï¼‰ï¼Œtenant ä½œä¸ºä¸‹ä¸€æ®µï¼š<global>:<tenant>:<calltype>:<hash>ï¼›é¿å…æŠŠ tenant äº¤ç»™å®¢æˆ·ç«¯è¯·æ±‚ä½“å­—æ®µæ§åˆ¶ã€‚è¯æ®å®šä½ï¼šredis.go (line 139), handler.go (line 169)ã€‚
è‹¥è¦å¼•å…¥ cache_controlï¼šåªå…è®¸ no-cache/no-store/max-age ç­‰å®‰å…¨å¼€å…³ï¼›namespace/ttl éœ€åšç™½åå•ä¸ä¸Šé™ï¼ˆä¾‹å¦‚ TTL ä¸Šé™ã€namespace å¼ºåˆ¶ä» auth æ´¾ç”Ÿï¼‰ã€‚è¯æ®ï¼šhandler.go (line 225)ã€‚
å»ºè®®å›å½’æµ‹è¯•ï¼ˆéªŒè¯ç‚¹ï¼‰
å¤šç§Ÿæˆ·éš”ç¦»ï¼šä¸¤æŠŠä¸åŒ API keyï¼ˆæˆ– team/orgï¼‰å¯¹åŒä¸€ model+messages è¯·æ±‚ï¼Œå¯ç”¨ç¼“å­˜ååº”ç”Ÿæˆä¸åŒ keyã€ä¸èƒ½äº’ç›¸å‘½ä¸­ï¼ˆE2E + å•æµ‹ï¼‰ã€‚è¯æ®å®šä½ï¼štenant æ¥æº types.go (line 186)ï¼Œç¼“å­˜å…¥å£ client.go (line 266)ã€‚
å­—æ®µè¦†ç›–ï¼šä»…æ”¹å˜ TopP/Tools/ToolChoice/ResponseFormat/Stop/N/Extra ç­‰å­—æ®µæ—¶ï¼Œkey å¿…é¡»å˜åŒ–ï¼Œä¸èƒ½é”™å‘½ä¸­ï¼ˆå•æµ‹ï¼‰ã€‚è¯æ®ï¼šå­—æ®µå®šä¹‰ request.go (line 9)ã€‚
å“ˆå¸Œå¼ºåº¦ï¼šç¡®è®¤ä¸å†ä½¿ç”¨ FNV64ï¼ˆå•æµ‹/é™æ€æ£€æŸ¥ï¼‰ã€‚è¯æ®ï¼šclient.go (line 1484)ã€‚



åŸºçº¿ï¼šed4f36149b3124d6be8f39caa7fedecf81b5b6a8

1) æ˜¯å¦è®°å½•/ä¸ŠæŠ¥æ•æ„Ÿä¿¡æ¯ï¼ˆé»˜è®¤æ˜¯å¦å®‰å…¨ï¼‰

ç”¨æˆ· prompt / ä¸Šæ¸¸å“åº”å†…å®¹ï¼ˆæ˜ç¡®ä¼šè¢«ä¸ŠæŠ¥ï¼‰ï¼šclient_handler.go (line 1007) å°† req.Messages æ”¾å…¥ payload.Messagesï¼›client_handler.go (line 259) å°†å®Œæ•´ resp æ”¾å…¥ payload.Responseã€‚å¯ç”¨å¯¹åº” callback åä¼šå¤–å‘ï¼š
Langfuseï¼šé»˜è®¤ä¸è„±æ•è¾“å…¥/è¾“å‡ºï¼ˆMaskInput/MaskOutput é»˜è®¤ falseï¼‰ï¼Œç›´æ¥ä¸ŠæŠ¥ payload.Messages/payload.Responseï¼šlangfuse_callback.go (line 232)ã€langfuse_callback.go (line 241)ã€langfuse_callback.go (line 30)
Datadog Logsï¼šé»˜è®¤ä¸å…³é—­ message loggingï¼ˆTurnOffMessageLogging é»˜è®¤ falseï¼Œä¸”é»˜è®¤é…ç½®æœªè®¾ç½®è¯¥å­—æ®µï¼‰ï¼Œä¼šæŠŠ messages/response å†™å…¥ log payloadï¼šdatadog_callback.go (line 316)ã€datadog_callback.go (line 69)
Datadog LLM Obsï¼šåŒæ ·é»˜è®¤ä¸å…³é—­ message loggingï¼Œä¼šæå–å¹¶ä¸ŠæŠ¥è¾“å…¥/è¾“å‡º messagesï¼šdatadog_llm_obs_callback.go (line 265)ã€datadog_llm_obs_callback.go (line 114)
PII/æ ‡è¯†ç¬¦ï¼ˆä¼šè¢«ä¸ŠæŠ¥/å…¥æŒ‡æ ‡ï¼‰ï¼špayload ä¼šåŒ…å« end_user/user/user_email/hashed_api_key/api_key_alias/team/orgï¼šcallback.go (line 68)ã€client_handler.go (line 1090)ã€‚Prometheus æŒ‡æ ‡ label ä¹ŸåŒ…å« end_user/user/hashed_api_key/api_key_aliasï¼šprometheus.go (line 37)ï¼›é¢„ç®—æŒ‡æ ‡ç”šè‡³åŒ…å« user_emailï¼šbudget.go (line 86)
Authorization / åŸå§‹ API keyï¼šæœªå‘ç°ç›´æ¥è®°å½• Authorization headerï¼›å­˜åœ¨ redactor è§„åˆ™ï¼ˆredact.go (line 27)ï¼‰ä½†ç”Ÿäº§ä»£ç æœªå®é™…è°ƒç”¨ï¼ˆredact.go (line 114) ä»…æµ‹è¯•è¦†ç›–ï¼šredact_test.go (line 127)ï¼‰ã€‚å¦å¤–æ’ä»¶æ—¥å¿—è‹¥å¼€å¯ä¼šç›´æ¥å†™å…¥ message/response å†…å®¹ä¸”ä¸èµ° redactionï¼šlogging.go (line 94)ã€logging.go (line 150)
é»˜è®¤æ˜¯å¦å®‰å…¨ï¼š
å¤–éƒ¨å›è°ƒï¼ˆLangfuse/Datadog/Slack/S3/OTelï¼‰æ•´ä½“æ˜¯â€œé…ç½®å¯ç”¨æ‰ç”Ÿæ•ˆâ€ï¼Œä½†ä¸€æ—¦å¯ç”¨ï¼ŒLangfuse/Datadog é»˜è®¤ä¼šå¸¦ä¸ŠåŸå§‹ messages/responseï¼ˆä¸å®‰å…¨ï¼‰ï¼šè§ä¸Šé¢è¯æ®
Prometheus callback é»˜è®¤å¯ç”¨ï¼šconfig.go (line 68)ã€config.go (line 136)ï¼Œä¸”å¸¦ PII/é«˜åŸºæ•° labelï¼ˆä¸å®‰å…¨ï¼Œè§ç¬¬ 3 ç‚¹ï¼‰
2) æ’ä»¶æœºåˆ¶æ˜¯å¦å¯è¢«æ»¥ç”¨ï¼ˆçŸ­è·¯/æ³¨å…¥/æ”¹è·¯ç”±ä¸Šä¸‹æ–‡/å®‰å…¨è¾¹ç•Œï¼‰

æ’ä»¶è¢«è®¾è®¡ä¸ºå¯â€œæ‹¦æˆªã€ä¿®æ”¹ã€çŸ­è·¯è¯·æ±‚/å“åº”â€ï¼šinterface.go (line 32)ã€interface.go (line 39)ã€interface.go (line 69)
æ’ä»¶å¯ä»¥ç›´æ¥è¯»å†™è·¯ç”±/é‰´æƒä¸Šä¸‹æ–‡ï¼ˆæ— åªè¯»å°è£…/æ— æ²™ç®±è¾¹ç•Œï¼‰ï¼šinterface.go (line 100)ï¼ˆProvider/Deployment/Auth éƒ½æ˜¯å¯¼å‡ºå­—æ®µï¼‰
Pipeline ä»…æä¾›æ¯ä¸ª hook çš„è¶…æ—¶ï¼ˆé»˜è®¤ 10sï¼‰ä½œä¸ºç²—ç²’åº¦æŠ¤æ ï¼špipeline.go (line 18)ã€pipeline.go (line 210)ï¼›æ²¡æœ‰èƒ½åŠ›éš”ç¦»ï¼ˆä¾‹å¦‚ç¦æ­¢ç½‘ç»œå¤–è¿/ç¦æ­¢æ”¹å†™å…³é”®å­—æ®µï¼‰
PropagateErrors å£°æ˜äº†ä½†â€œæœªå®Œæ•´å®ç°â€ï¼špipeline.go (line 24)ã€pipeline.go (line 236)ï¼ˆè¿™ä¼šè®©ä½¿ç”¨è€…è¯¯ä»¥ä¸ºå¯æ§é”™è¯¯ä¼ æ’­è¾¹ç•Œï¼‰
3) DoSï¼šæ—¥å¿—/metrics æ ‡ç­¾é«˜åŸºæ•°å¯¼è‡´ Prometheus çˆ†ç‚¸ï¼Ÿ

Prometheus æŒ‡æ ‡å¤§é‡ label ç»´åº¦åŒ…å«ç”¨æˆ·ç»´åº¦ä¸ key ç»´åº¦ï¼šprometheus.go (line 37)ã€prometheus.go (line 72)ï¼›é¢„ç®—æŒ‡æ ‡åŒ…å« user_emailï¼šbudget.go (line 93)
end_user ç”šè‡³å¯ç›´æ¥ç”±è¯·æ±‚å­—æ®µæ³¨å…¥ï¼šclient_handler.go (line 1090)ï¼ˆrequestUser != "" å°±å†™å…¥ payload.EndUserï¼‰ï¼Œè¿™æ„å‘³ç€æ”»å‡»è€…å¯æ„é€ éšæœº user å€¼å¯¼è‡´é«˜åŸºæ•° label çˆ†ç‚¸
Observability ä¾§è™½ç„¶å®ç°äº† label filter managerï¼Œä½† PrometheusCallback/Collector å¹¶æœªä½¿ç”¨å®ƒï¼ˆè§ filter.go (line 167)ã€config.go (line 126) çš„å­˜åœ¨æ€§ï¼›ä½† prometheus_callback.go (line 90) ç›´æ¥æŠŠ payload.User/EndUser/HashedAPIKey/... å¡«å…¥ labelsï¼‰
4) å›è°ƒå¤±è´¥æ˜¯å¦å½±å“ä¸»é“¾è·¯ï¼ˆé‡è¯•é£æš´/é˜»å¡ï¼‰

CallbackManager å¯¹å›è°ƒæ˜¯åŒæ­¥éå†è°ƒç”¨ï¼Œä½†é”™è¯¯åªè®°å½•æ—¥å¿—ã€ä¸å›ä¼ ä¸»é“¾è·¯ï¼šcallback.go (line 171)ï¼ˆå› æ­¤â€œåŠŸèƒ½ä¸Šä¸å½±å“è¿”å›â€ï¼Œä½†ä»ä¼šæ¶ˆè€— CPU/é”ç«äº‰ï¼‰
ä½†æœ‰ä¸¤ä¸ªç°å®é£é™©ï¼š
é˜»å¡ä¸»é“¾è·¯ï¼šSlack å›è°ƒåœ¨å¤±è´¥/å›é€€äº‹ä»¶ä¸Šä¼šåŒæ­¥å‘ HTTPï¼ˆclient è¶…æ—¶ 10sï¼‰ï¼Œä¼šå ç”¨è¯·æ±‚è·¯å¾„æ—¶é—´ï¼šslack_callback.go (line 88)ã€slack_callback.go (line 123)
goroutine/flush é£æš´ + ä¸¢æ•°ï¼šDatadog/S3/Datadog LLM Obs é‡‡ç”¨â€œè¾¾åˆ° batch size å°±èµ· goroutine flushâ€ï¼Œæ— å¹¶å‘ä¸Šé™ï¼šdatadog_callback.go (line 361)ã€s3_callback.go (line 246)ã€datadog_llm_obs_callback.go (line 452)ï¼›flush å¤±è´¥åé€šå¸¸ç›´æ¥åæ‰é”™è¯¯å¹¶æ¸…ç©ºé˜Ÿåˆ—ï¼ˆé™é»˜ä¸¢è§‚æµ‹æ•°æ®ï¼‰
5) â€œçœ‹ä¼¼æœ‰æŒ‡æ ‡/æ’ä»¶ï¼Œä½†å®é™…æ— æ•ˆæˆ–è¯¯å¯¼â€çš„å®ç°

å†…å®¹è¿‡æ»¤ RedactPatterns é…ç½®é¡¹å­˜åœ¨ä½†ä»æœªç¼–è¯‘/æ³¨å…¥åˆ° ContentFilter.RedactPatternsï¼ˆå®é™…æ°¸è¿œä¸ºç©ºï¼Œç­‰äºæ— æ•ˆï¼‰ï¼šconfig.go (line 45)ã€config.go (line 118)ã€filter.go (line 91)
Redactor.RedactHeaders/é»˜è®¤æ•æ„Ÿæ¨¡å¼å­˜åœ¨ä½†ç”Ÿäº§æœªç”¨ï¼šredact.go (line 114)
OTelCallbackConfig.IncludeMessages å­—æ®µå­˜åœ¨ä½† callback å†…æ²¡æœ‰ä»»ä½•åœ°æ–¹ä½¿ç”¨ï¼ˆä»…æ„é€ èµ‹å€¼ï¼‰ï¼šotel_callback.go (line 50)
å¤šä¸ª internal æŒ‡æ ‡å®šä¹‰åæœªæ›´æ–°ï¼ˆæ˜“è¯¯å¯¼â€œæœ‰ç›‘æ§â€ï¼‰ï¼šinternal.go (line 44)ï¼ˆä»“åº“å†…æ— å¼•ç”¨æ›´æ–°ï¼‰
ObservabilityPlugin ç»“æ„ä½“å« redactor ä½† PostHook ä»…è®°å½• metricsï¼Œå­—æ®µæœªç”¨ï¼šplugin.go (line 11)
å¯è§‚æµ‹æ•°æ®åˆ†ç±»ï¼ˆæ•æ„Ÿç­‰çº§ï¼‰+ é»˜è®¤ç­–ç•¥å»ºè®®

S0 æœºå¯†ï¼šAPI key/å¯†é’¥/Token/Slack webhook/AWS secretï¼ˆå»ºè®®ï¼šé»˜è®¤æ°¸ä¸è½ç›˜/æ°¸ä¸å¤–å‘ï¼›ä»…å…è®¸â€œæ˜¾å¼å¼€å¯ + å¼º redaction + æœ€å°ç•™å­˜â€ï¼‰
S1 é«˜æ•å†…å®¹ï¼šç”¨æˆ· promptã€æ¨¡å‹è¾“å‡ºã€embedding è¾“å…¥ã€å·¥å…·å‚æ•°ï¼ˆå»ºè®®ï¼šé»˜è®¤ä¸é‡‡é›†ï¼›å¦‚éœ€é‡‡é›†ï¼Œå¿…é¡» opt-in å¹¶æä¾›æŒ‰å­—æ®µå¼€å…³ä¸å¼ºåˆ¶è„±æ•/æˆªæ–­ï¼‰
S2 PII/å¯è¯†åˆ«æ ‡è¯†ï¼šuser/end_user/user_email/ip/hashed_api_key/api_key_alias/team/orgï¼ˆå»ºè®®ï¼šé»˜è®¤ä¸è¿›å…¥ Prometheus labelsï¼›å¯è¿›å…¥æ—¥å¿—ä½†éœ€è„±æ•/å“ˆå¸Œ/åˆ†æ¡¶ï¼‰
S3 è¿è¥æ•°æ®ï¼šmodel/provider/status/latency/token/costï¼ˆå»ºè®®ï¼šé»˜è®¤å¯é‡‡é›†ï¼Œä¸”ä¿æŒä½åŸºæ•°ï¼‰
é«˜åŸºæ•°/æ³„éœ²/æ³¨å…¥é£é™©æ¸…å• + ä¿®å¤å»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

P0 æ³„éœ²ï¼šå¤–éƒ¨å›è°ƒé»˜è®¤ä¸ŠæŠ¥ messages/responseï¼ˆLangfuse/Datadog/Datadog LLM Obsï¼‰â†’ é»˜è®¤æ”¹ä¸ºâ€œå…³é—­ message logging / MaskInput+MaskOutput=trueâ€ï¼Œå¹¶è¦æ±‚æ˜¾å¼å¼€å…³å¼€å¯ï¼ˆè¯æ®è§ langfuse_callback.go (line 30)ã€datadog_callback.go (line 316)ã€datadog_llm_obs_callback.go (line 265)ï¼‰
P0 DoSï¼šPrometheus é»˜è®¤å¯ç”¨ä¸”å¸¦ end_user/user/hashed_api_key/user_email ç­‰é«˜åŸºæ•°/PII label â†’ é»˜è®¤ä»æŒ‡æ ‡ label ç§»é™¤è¿™äº›ç»´åº¦ï¼Œä»…ä¿ç•™ provider/model/status/deploymentï¼›æŠŠç”¨æˆ·ç»´åº¦æ”¹ä¸ºæ—¥å¿—æˆ– traces exemplarï¼ˆè¯æ®è§ config.go (line 136)ã€prometheus.go (line 37)ã€budget.go (line 93)ã€client_handler.go (line 1090)ï¼‰
P1 æ’ä»¶æ»¥ç”¨ï¼šæ’ä»¶æ— è¾¹ç•Œï¼Œå¯æ”¹å†™ä¸Šä¸‹æ–‡/çŸ­è·¯ â†’ æ˜ç¡®æ–‡æ¡£â€œæ’ä»¶ä»…å¯ä¿¡ä»£ç â€ï¼›æˆ–å¼•å…¥åªè¯» ContextViewã€ç¦æ­¢å†™ Auth/Deploymentã€æŠŠâ€œæ”¹è·¯ç”±/çŸ­è·¯â€æ‹†æˆå—æ§ capabilityï¼ˆè¯æ®è§ interface.go (line 32)ã€interface.go (line 100)ï¼‰
P1 å¯é æ€§ï¼šå›è°ƒ flush goroutine æ— ä¸Šé™ã€å¤±è´¥é™é»˜ä¸¢æ•°ï¼›Slack å¯é˜»å¡ â†’ å¢åŠ æœ‰ç•Œé˜Ÿåˆ—+å›ºå®š workerã€å¤±è´¥è®¡æ•°æŒ‡æ ‡ã€å¯¹ Slack æ”¹ä¸ºå¼‚æ­¥/ç†”æ–­/æ›´çŸ­è¶…æ—¶ï¼ˆè¯æ®è§ datadog_callback.go (line 361)ã€s3_callback.go (line 246)ã€slack_callback.go (line 88)ï¼‰
P2 è¯¯å¯¼ï¼šContentFilter.RedactPatterns/redactor/label filter/includeMessages/internal queue metrics å¤šå¤„â€œå£°æ˜ä½†æœªç”Ÿæ•ˆâ€ â†’ è¦ä¹ˆè¡¥é½ wiringï¼ˆç¼–è¯‘ regexã€æ¥å…¥ logger redactionã€Prometheus label è¿‡æ»¤ã€æ›´æ–°é˜Ÿåˆ— gaugeï¼‰ï¼Œè¦ä¹ˆåˆ æ‰é¿å…è¯¯è§£ï¼ˆè¯æ®è§ config.go (line 45)ã€filter.go (line 91)ã€internal.go (line 44)ï¼‰


1) é»˜è®¤é…ç½®æ˜¯å¦å®‰å…¨ï¼ˆauth/CORS/metrics/admin_port/debugï¼‰

auth é»˜è®¤ä¸å®‰å…¨ï¼šé»˜è®¤å…³é—­è®¤è¯ Auth.Enabled=falseï¼ˆconfig.go (line 399)ï¼‰ï¼Œç¤ºä¾‹ä¹Ÿé»˜è®¤å…³é—­ï¼ˆconfig.example.yaml (line 153)ï¼‰ï¼›åŒæ—¶ç®¡ç†ç«¯ç‚¹é»˜è®¤ä¼šè¢«æ³¨å†Œï¼ˆmain.go (line 258)ã€routes.go (line 14)ï¼‰ï¼Œåœ¨ auth å…³é—­æ—¶ç­‰åŒäºâ€œæ— éœ€é‰´æƒå³å¯è°ƒç”¨ /key/* /control/*â€ã€‚
admin_port é»˜è®¤ä¸å®‰å…¨ï¼šé»˜è®¤ admin_port=0ï¼ˆconfig.go (line 323)ã€config.example.yaml (line 6)ï¼‰ï¼Œæ­¤æ—¶ç®¡ç†/æ§åˆ¶/UI ä¼šæ³¨å†Œåˆ°æ•°æ®é¢åŒä¸€ä¸ª muxï¼ˆroutes.go (line 46)ã€routes.go (line 54)ï¼‰ï¼Œæ„å‘³ç€é»˜è®¤ä¸åšâ€œç®¡ç†é¢/æ•°æ®é¢éš”ç¦»â€ã€‚
metrics é»˜è®¤æš´éœ²ï¼šé»˜è®¤å¯ç”¨å¹¶æŒ‚åœ¨æ•°æ®é¢ï¼ˆconfig.go (line 364)ã€routes.go (line 82)ï¼‰ï¼›å¹¶ä¸”å³ä½¿å¯ç”¨ authï¼Œé»˜è®¤ä¹ŸæŠŠ /metrics æ”¾è¿› skipï¼ˆconfig.go (line 401)ã€middleware.go (line 64)ï¼‰ï¼Œæ‰€ä»¥å¸¸è§éƒ¨ç½²ä¼šå˜æˆâ€œæŒ‡æ ‡æ°¸è¿œä¸é‰´æƒæš´éœ²â€ã€‚
CORS é»˜è®¤ç›¸å¯¹å®‰å…¨ï¼šé»˜è®¤å…³é—­ CORSï¼ˆconfig.go (line 376)ã€cors.go (line 12)ï¼‰ï¼Œä¸ä¼šç»™æµè§ˆå™¨è·¨åŸŸæ”¾è¡Œã€‚
debug æ—¥å¿—ï¼šé…ç½®å±‚é»˜è®¤ infoï¼ˆconfig.go (line 360)ã€config.example.yaml (line 97)ï¼‰ï¼Œä¸”æœåŠ¡ç«¯ logger åœ¨å¯åŠ¨æ—¶ç¡¬ç¼–ç  INFOï¼ˆmain.go (line 48)ï¼‰ï¼Œconfig.test.yaml (line 46) é‡Œçš„ debug ä¹Ÿä¸ä¼šå½±å“è¯¥ loggerï¼ˆå­˜åœ¨â€œé…ç½®ä¸å®é™…ä¸ä¸€è‡´â€ï¼Œè§ç¬¬ 5 ç‚¹ï¼‰ã€‚
2) é…ç½®æ¨¡æ¿æ˜¯å¦è¯±å¯¼è¯¯ç”¨ï¼ˆsecret ç®¡ç† / é˜²è¯¯æäº¤ï¼‰

æœ‰é˜²æŠ¤ï¼šç¤ºä¾‹ç”¨ ${VAR} è€ŒéçœŸ keyï¼ˆconfig.example.yaml (line 17)ï¼‰ï¼Œ.env ä¸æœ¬åœ° config é»˜è®¤è¢«å¿½ç•¥ï¼ˆ.gitignore (line 35)ã€.gitignore (line 41)ï¼‰ï¼Œk8s secret.yaml è¢«å¿½ç•¥ï¼ˆ.gitignore (line 54)ï¼‰ï¼Œå¹¶æä¾›æ˜ç¡®è­¦å‘Šï¼ˆsecret.example.yaml (line 1)ï¼‰ã€‚
ä»æœ‰â€œæ˜“è¯¯ç”¨â€ç‚¹ï¼š
æ–‡æ¡£ç¤ºä¾‹ç›´æ¥æŠŠ key æ”¾å‘½ä»¤è¡Œå‚æ•°/--from-literalï¼Œå®¹æ˜“è¿› shell history / å®¡è®¡æ—¥å¿—ï¼ˆREADME.md (line 12)ã€README.md (line 41)ï¼‰ã€‚
é…ç½®æ¨¡æ¿å¤§é‡ä½¿ç”¨ ${DB_HOST:localhost} è¿™ç§â€œå¸¦é»˜è®¤å€¼è¯­æ³•â€ï¼Œä½†åŠ è½½å™¨åªå£°æ˜æ”¯æŒ ${VAR_NAME}ï¼ˆconfig.go (line 451)ã€config.go (line 459)ï¼‰ï¼Œä¼šå¯¼è‡´ç”¨æˆ·ä»¥ä¸ºæœ‰é»˜è®¤å€¼ã€å®é™…æ²¡æœ‰ï¼ˆä¾‹å¦‚ config.example.yaml (line 172)ã€config.distributed.yaml (line 40)ï¼‰ã€‚
3) Dockerfile ä¸é•œåƒå®‰å…¨

åšå¾—å¥½çš„ï¼šæœ€ç»ˆé•œåƒ distroless + nonrootï¼ˆDockerfile (line 23)ã€Dockerfile (line 32)ï¼‰ï¼Œæ”»å‡»é¢å°ã€‚
å…³é”®é£é™©ï¼šé•œåƒå†…é»˜è®¤å¤åˆ¶ config.example.yamlï¼ˆDockerfile (line 29)ï¼‰ï¼Œè€Œè¯¥ç¤ºä¾‹ auth.enabled=falseï¼ˆconfig.example.yaml (line 154)ï¼‰+ é»˜è®¤ admin_port=0ï¼ˆconfig.example.yaml (line 6)ï¼‰= é»˜è®¤å¯åŠ¨å°±æŠŠç®¡ç†ç«¯ç‚¹å’Œ UI æš´éœ²åœ¨åŒä¸€ HTTP ç«¯å£ï¼ˆroutes.go (line 54)ã€routes.go (line 14)ï¼‰ã€‚
ä¾›åº”é“¾é£é™©ï¼šbuilder go mod downloadï¼ˆDockerfile (line 11)ï¼‰+ base image tag æœª pin digestï¼ˆDockerfile (line 2)ã€Dockerfile (line 23)ï¼‰ã€‚
4) K8sï¼ˆRBAC/Secret/NetworkPolicy/èµ„æºé™åˆ¶/å±é™©é»˜è®¤å€¼ï¼‰

åšå¾—å¥½çš„ï¼šPod/å®¹å™¨å®‰å…¨ä¸Šä¸‹æ–‡è¾ƒå®Œæ•´ï¼ˆdeployment.yaml (line 22)ã€deployment.yaml (line 53)ï¼‰ï¼Œåªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆdeployment.yaml (line 55)ï¼‰ï¼Œèµ„æº requests/limitsï¼ˆdeployment.yaml (line 60)ï¼‰ï¼Œæ¢é’ˆï¼ˆdeployment.yaml (line 66)ï¼‰ï¼ŒService é»˜è®¤ ClusterIPï¼ˆservice.yaml (line 9)ï¼‰ã€‚
æ˜æ˜¾å±é™©é»˜è®¤å€¼ï¼š
ConfigMap é‡Œæœªé…ç½® authï¼ˆconfigmap.yaml (line 7) èµ·ï¼‰ï¼Œæ‰€ä»¥ä¼šè½å›é»˜è®¤ Auth.Enabled=falseï¼ˆconfig.go (line 399)ï¼‰ï¼›åŒæ—¶ admin_port æœªåˆ†ç¦»ï¼Œç®¡ç†ç«¯ç‚¹é»˜è®¤è½åœ¨åŒç«¯å£ï¼ˆroutes.go (line 54)ï¼‰ã€‚
é•œåƒ :latest + Alwaysï¼ˆdeployment.yaml (line 29)ã€deployment.yaml (line 30)ï¼‰ï¼Œä¾›åº”é“¾ä¸å›æ»šé£é™©ã€‚
å»ºè®®è¡¥é½ï¼š
automountServiceAccountToken: falseï¼ˆæœªé…ç½®åˆ™é»˜è®¤æŒ‚è½½ tokenï¼‰ï¼Œä»¥åŠæœ€å°æƒé™ ServiceAccountï¼ˆå¦‚æœªæ¥éœ€è¦è®¿é—® K8s APIï¼‰ã€‚
NetworkPolicyï¼šè‡³å°‘éš”ç¦»æ•°æ®é¢ï¼ˆ/v1ï¼‰ä¸æŒ‡æ ‡é¢ï¼ˆ/metricsï¼‰è®¿é—®æºï¼›ç®¡ç†é¢è‹¥å¼€å¯ admin_portï¼Œå»ºè®®å•ç‹¬ Service + åªå…è®¸è¿ç»´ç½‘æ®µ/Prometheus æŠ“å–ã€‚
DB/Redisï¼šæ¨¡æ¿é»˜è®¤ ssl_mode: disableï¼ˆconfig.distributed.yaml (line 45)ï¼‰ï¼Œç”Ÿäº§å»ºè®®å¼ºåˆ¶ TLSã€‚
5) â€œçœ‹èµ·æ¥æ”¯æŒ distributed/enterpriseï¼Œä½†é…ç½®ä¸å®ç°ä¸ä¸€è‡´â€æ¸…å•

README å£°ç§°â€œç®¡ç†ç«¯ç‚¹åœ¨ database é…ç½®åå¯ç”¨â€ï¼ˆREADME.md (line 193)ï¼‰ï¼Œä½†å®é™…æ— è®º DB å¼€å…³éƒ½ä¼šåˆ›å»ºç®¡ç† handlerï¼ˆmain.go (line 258)ï¼‰ï¼Œä¸” DB å…³é—­æ—¶ä»å¯ç”¨ in-memory auth storeï¼ˆauth_store.go (line 34)ï¼‰å¹¶æ³¨å†Œç®¡ç†è·¯ç”±ï¼ˆroutes.go (line 54)ã€routes.go (line 14)ï¼‰ã€‚
KeyType/æƒé™æ¨¡å‹ç–‘ä¼¼æœªè½åœ°ï¼šå®šä¹‰äº† KeyTypeManagementï¼ˆtypes.go (line 13)ï¼‰ï¼Œä½†ä»£ç ä¸­æœªè§å¯¹ç®¡ç†è·¯ç”±è¿›è¡Œ KeyType/è§’è‰²æ ¡éªŒï¼ˆmanagement.go (line 86) èµ·æ— é‰´æƒé€»è¾‘ï¼Œä¸” auth middleware ä»…â€œè®¤è¯â€ä¸â€œæˆæƒâ€ï¼Œmiddleware.go (line 70)ï¼‰ã€‚
é…ç½®æ¨¡æ¿å†™æ³•ä¸åŠ è½½å™¨ä¸ä¸€è‡´ï¼šæ¨¡æ¿ä½¿ç”¨ ${VAR:default}ï¼ˆå¦‚ config.example.yaml (line 172)ï¼‰ï¼Œä½†åŠ è½½å™¨ä»… os.ExpandEnvï¼ˆconfig.go (line 459)ï¼‰ï¼Œä¼šè¯¯å¯¼ç”¨æˆ·ã€‚
config.distributed.min.yaml æ ‡æ³¨ distributedï¼Œä½† auth.enabled=falseï¼ˆconfig.distributed.min.yaml (line 32)ï¼‰ï¼›è€Œæµ‹è¯•æŒ‡å—åˆå¼ºè°ƒ distributed é…ç½®ä¼šå¯ç”¨ authï¼ˆPRODUCTION_TEST_GUIDE.md (line 103)ï¼‰ã€‚
README.md å¼•ç”¨ Helm chart è·¯å¾„ï¼ˆREADME.md (line 46)ï¼‰ï¼Œä½†ä»“åº“å†…æ—  helm/ ç›®å½•ï¼ˆæ–‡æ¡£ä¸äº¤ä»˜ç‰©ä¸ä¸€è‡´ï¼‰ã€‚
logging.level å‡ºç°åœ¨é…ç½®ç»“æ„ä¸ç¤ºä¾‹ï¼ˆconfig.go (line 360)ã€config.example.yaml (line 97)ï¼‰ï¼Œä½† server å¯åŠ¨ logger å›ºå®š INFOï¼ˆmain.go (line 48)ï¼‰ï¼Œæ˜“é€ æˆâ€œä»¥ä¸ºè°ƒäº†æ—¥å¿—çº§åˆ«ä½†å®é™…æ²¡ç”Ÿæ•ˆâ€ã€‚
ä¸€é¡µ Hardening Checklistï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰

å¿…åšï¼šç”Ÿäº§ç¯å¢ƒå¯ç”¨è®¤è¯ auth.enabled=trueï¼ˆconfig.go (line 399)ã€config.distributed.yaml (line 31)ï¼‰ï¼Œå¹¶é»˜è®¤æŠŠç®¡ç†é¢ä¸æ•°æ®é¢éš”ç¦»ï¼šè®¾ç½® server.admin_port>0ï¼ˆconfig.go (line 323)ã€routes.go (line 46)ï¼‰ï¼Œä¸º admin port å•ç‹¬ Service/Ingress + ç½‘ç»œç™½åå•ã€‚
å¿…åšï¼šé™åˆ¶ç®¡ç†ç«¯ç‚¹ï¼ˆ/key/* /control/* ç­‰ï¼Œroutes.go (line 14)ï¼‰ï¼šçŸ­æœŸç”¨ç½‘ç»œéš”ç¦»ï¼›ä¸­æœŸåº”åœ¨ä»£ç å±‚åšâ€œæˆæƒâ€ï¼ˆè‡³å°‘åŒºåˆ† KeyTypeManagementï¼Œtypes.go (line 13)ï¼‰ã€‚
å¿…åšï¼šé™åˆ¶ /metricsï¼šé¿å…å…¬ç½‘/å¤šç§Ÿæˆ·ç½‘æ®µå¯è¾¾ï¼›å¦‚å¿…é¡»æš´éœ²ï¼Œå»ºè®®å•ç‹¬ç«¯å£/å•ç‹¬ Service/NetworkPolicyï¼›å¹¶è€ƒè™‘ä» auth.skip_paths ç§»é™¤ /metricsï¼ˆé»˜è®¤åŒ…å«ï¼Œconfig.go (line 401)ï¼‰ã€‚
å»ºè®®ï¼šä¿®æ­£æ¨¡æ¿å˜é‡è¯­æ³•ä¸ºçº¯ ${VAR}ï¼ˆä¸ config.go (line 451) å¯¹é½ï¼‰ï¼Œå¹¶è¡¥å……æ–‡æ¡£æ¨èç”¨ env://OPENAI_API_KEY / vault://...ï¼ˆå·²æœ‰å®ç°ï¼šprovider.go (line 8)ã€main.go (line 429)ï¼‰ã€‚
å»ºè®®ï¼šK8s å¢åŠ  automountServiceAccountToken:falseã€seccompProfile: RuntimeDefaultã€NetworkPolicyï¼›é•œåƒæ”¹ç”¨ digest pin + IfNotPresentï¼›DB å¼ºåˆ¶ TLSï¼ˆé¿å… ssl_mode: disableï¼Œconfig.distributed.yaml (line 45)ï¼‰ã€‚
å»ºè®®ï¼šDocker è¿è¡Œæ—¶åŠ å›ºï¼ˆç¤ºä¾‹ï¼‰ï¼š--read-only --cap-drop=ALL --security-opt=no-new-privilegesï¼Œå¹¶é¿å…æŠŠ key æ”¾å‘½ä»¤è¡Œï¼ˆREADME.md (line 12)ã€README.md (line 41) çš„å†™æ³•å®¹æ˜“è¿›å†å²ï¼‰ã€‚




ç»“è®ºæ‘˜è¦

å½“å‰ ui/ æœ¬èº«æ²¡æœ‰å¯ç”¨çš„é‰´æƒé—­ç¯ï¼ˆç™»å½•/ç™»å‡ºå‡æœªçœŸæ­£ç”Ÿæ•ˆï¼‰ï¼Œå¹¶ä¸”ç®¡ç† API çš„é‰´æƒåœ¨é»˜è®¤é…ç½®ä¸‹æ˜¯å…³é—­çš„ï¼Œå¯¼è‡´â€œæŠŠç®¡ç†ç«¯å£æš´éœ²åˆ°ç½‘ç»œâ€æ—¶å­˜åœ¨**æœªæˆæƒè®¿é—®/ä»»æ„ç®¡ç†æ“ä½œï¼ˆCriticalï¼‰**é£é™©ã€‚
æœªå‘ç° dangerouslySetInnerHTML ç­‰å…¸å‹å‰ç«¯ XSS æ³¨å…¥ç‚¹ï¼›ä¸»è¦é£é™©æ¥è‡ªâ€œç¼ºå¤±é‰´æƒ + ç ´åæ€§æ“ä½œç¼ºå°‘ç¡®è®¤ + å®‰å…¨å“åº”å¤´ç¼ºå¤± + dev ä¾èµ–é«˜å±æ¼æ´â€ã€‚
1) UI æ˜¯å¦æœ‰é‰´æƒï¼Ÿtoken å­˜å“ªé‡Œï¼Ÿæ˜¯å¦ä¼šæ³„éœ²åˆ°æ—¥å¿—/LocalStorage/URLï¼Ÿï¼ˆå¸¦è¯æ®ï¼‰
UI ä¾§æ— æœ‰æ•ˆé‰´æƒå®ç°

ç™»å½•é¡µçš„â€œè´¦å·å¯†ç ç™»å½•â€åªæ˜¯æ¨¡æ‹Ÿå»¶æ—¶ï¼Œå¹¶æœªè°ƒç”¨ä»»ä½•é‰´æƒ APIï¼špage.tsx (line 16)ã€‚
â€œSSO ç™»å½•â€åªæ˜¯è·³è½¬åˆ°ç¡¬ç¼–ç è·¯å¾„ï¼Œä½†ä»“åº“å†…å¹¶ä¸å­˜åœ¨å¯¹åº”åç«¯è·¯ç”±å®ç°ï¼ˆä»… UI å¼•ç”¨ï¼‰ï¼špage.tsx (line 25)ã€‚
â€œSign outâ€æŒ‰é’®æ²¡æœ‰ä»»ä½•ç™»å‡ºé€»è¾‘ï¼ˆæ—  handlerï¼‰ï¼šdashboard-layout.tsx (line 150)ã€‚
token å­˜å‚¨æ–¹å¼ï¼šæœªå®ç°æŒä¹…åŒ–ï¼›API client ä»…æ”¯æŒå†…å­˜ token

LLMuxApiClient é‡Œåªæœ‰ private token: string | nullï¼Œé€šè¿‡ setToken() è®¾ç½®åˆ°å†…å­˜å­—æ®µï¼›æ²¡æœ‰è½ç›˜é€»è¾‘ï¼šclient.ts (line 59)ã€client.ts (line 68)ã€‚
å…¨ ui/src æœªå‡ºç° localStorage/sessionStorageï¼šå‘½ä»¤ rg -n "localStorage|sessionStorage" ui/src è¿”å›ç©ºï¼ˆæœ¬æ¬¡å®¡è®¡ç°åœºç»“æœï¼‰ã€‚
API client ä»…åœ¨å†…å­˜ token å­˜åœ¨æ—¶æ‰åŠ  Authorization: Bearer ...ï¼šclient.ts (line 110)ã€‚
Next é…ç½®é‡Œæœ‰ console.log ä½†ä»…æ‰“å° NODE_ENVï¼Œä¸æ¶‰åŠ tokenï¼šnext.config.mjs (line 3)ã€‚
ç»“è®ºï¼šUI å½“å‰æ²¡æœ‰â€œå¯ç”¨çš„é‰´æƒ/ä¼šè¯/ä»¤ç‰Œå­˜å‚¨â€æ–¹æ¡ˆï¼Œå› æ­¤ä¹Ÿè°ˆä¸ä¸Š token æ³„éœ²åˆ° LocalStorage/URLï¼›çœŸæ­£é—®é¢˜æ˜¯é»˜è®¤æƒ…å†µä¸‹ç®¡ç†èƒ½åŠ›å¯èƒ½å¯¹æœªæˆæƒç”¨æˆ·å¼€æ”¾ï¼ˆè§ç¬¬ 2/5 ç‚¹ï¼‰ã€‚

2) API è¯·æ±‚æ˜¯å¦å¯èƒ½è¢« CSRF/SSRFï¼ˆå‰ç«¯ä¾§ï¼‰æˆ–è¢«æ¶æ„è„šæœ¬æ»¥ç”¨ï¼ŸCORS é…ç½®æ˜¯å¦å®‰å…¨ï¼Ÿï¼ˆå¸¦è¯æ®ï¼‰
å‰ç«¯ä¾§ SSRFï¼šåŸºæœ¬ä¸æˆç«‹

ui/ ä¸ºçº¯æµè§ˆå™¨ç«¯ fetchï¼Œä¸å­˜åœ¨â€œæœåŠ¡ç«¯ä»£å‘è¯·æ±‚â€çš„ Next API Route/Server Actionï¼Œå› æ­¤æ²¡æœ‰å…¸å‹ SSRF é¢ï¼šclient.ts (line 115)ï¼ˆç›´æ¥ fetch(url.toString())ï¼‰ã€‚
CSRF/è·¨ç«™æ»¥ç”¨ï¼šå–å†³äºåç«¯æ˜¯å¦å¼€å¯é‰´æƒï¼›å½“å‰é»˜è®¤é…ç½®ä¸‹é£é™©å¾ˆé«˜

åç«¯é‰´æƒä¸­é—´ä»¶åªåœ¨ cfg.Auth.Enabled æ—¶å¯ç”¨ï¼šmiddleware.go (line 20)ã€‚
é»˜è®¤é…ç½® Auth.Enabled=falseï¼šconfig.go (line 399)ã€‚
å¤šä¸ªç®¡ç†å†™æ¥å£ç›´æ¥ json.NewDecoder(r.Body).Decode(&req)ï¼Œä¸æ ¡éªŒ Content-Typeï¼Œå› æ­¤å½“â€œåç«¯æœªè¦æ±‚é‰´æƒâ€æ—¶ï¼Œç¬¬ä¸‰æ–¹ç«™ç‚¹å¯ç”¨ç®€å•è¯·æ±‚è§¦å‘çŠ¶æ€æ”¹å˜ï¼ˆæ— éœ€è¯»å–å“åº”ï¼‰ï¼š
ä¾‹å¦‚åˆ›å»º keyï¼šmanagement.go (line 89)
ä¾‹å¦‚åˆ›å»º teamï¼šteam_endpoints.go (line 46)
ä¾‹å¦‚åˆ›å»º userï¼šuser_endpoints.go (line 40)
CORS é…ç½®ï¼ˆåç«¯ï¼‰æ€»ä½“æ˜¯â€œé»˜è®¤å®‰å…¨ã€ä½†å¾ˆå®¹æ˜“è¢«ä¸ºäº†è”è°ƒè€Œé…åâ€

CORS ä¸­é—´ä»¶é»˜è®¤ Enabled=falseï¼šconfig.go (line 376)ã€‚
ä¸€æ—¦å¼€å¯ï¼Œé‡‡ç”¨ allowlist/denylist å¹¶åŒºåˆ† admin/data è·¯å¾„å‰ç¼€ï¼šcors.go (line 27)ã€cors.go (line 32)ã€‚
ä½† UI dev é…ç½®å†™äº†â€œé¿å… CORS çš„ rewriteâ€ï¼Œåªä»£ç† /api/v1/*ï¼šnext.config.mjs (line 16)ï¼›è€Œ UI å®é™…è°ƒç”¨çš„æ˜¯ /key/*ã€/user/* ç­‰ï¼ˆè§ client.ts (line 158)ã€use-users.ts (line 42)ï¼‰ï¼Œå¯¼è‡´å¼€å‘è€…å¾ˆå¯èƒ½ä¸ºäº†è®© UI åœ¨ localhost (line 3000) è°ƒ localhost (line 8080) è·‘èµ·æ¥è€Œæ‰“å¼€å®½æ¾ CORSï¼ˆè¿™ä¼šæ”¾å¤§â€œæ¶æ„ç«™ç‚¹æ»¥ç”¨ APIâ€çš„é¢ï¼‰ã€‚
3) XSSï¼šç”¨æˆ·å¯æ§å†…å®¹æ˜¯å¦è¿›å…¥ dangerouslySetInnerHTML æˆ–æœªè½¬ä¹‰æ¸²æŸ“ï¼Ÿï¼ˆå¸¦è¯æ®ï¼‰
ui/src å†…æœªå‘ç° dangerouslySetInnerHTMLï¼šå‘½ä»¤ rg -n "dangerouslySetInnerHTML" ui/src è¿”å›ç©ºï¼ˆæœ¬æ¬¡å®¡è®¡ç°åœºç»“æœï¼‰ã€‚
UI æ¸²æŸ“ API è¿”å›å­—æ®µï¼ˆå¦‚ key/name ç­‰ï¼‰é‡‡ç”¨ React JSX é»˜è®¤è½¬ä¹‰ï¼ˆä¾‹å¦‚å±•ç¤ºåˆ›å»ºå‡ºæ¥çš„ keyï¼‰ï¼špage.tsx (line 310)ã€‚
ç»“è®ºï¼šæœªçœ‹åˆ°â€œç›´æ¥æŠŠç”¨æˆ·è¾“å…¥å½“ HTML æ³¨å…¥â€çš„æ˜æ˜¾ XSS ç‚¹ï¼›æ›´å¤§çš„é—®é¢˜æ˜¯é‰´æƒç¼ºå¤±å¯¼è‡´çš„æ•°æ®/æ“ä½œæš´éœ²ã€‚
4) ä¾èµ–é£é™©ï¼šnode_modules ä¸­é«˜å±ä¾èµ–ä¸ä¿®å¤å»ºè®®ï¼ˆå¸¦è¯æ®ï¼‰
npm audit ç»“æœ

ç”Ÿäº§ä¾èµ–ï¼šnpm --registry=https://registry.npmjs.org/ audit --omit=dev æ˜¾ç¤º found 0 vulnerabilitiesï¼ˆæœ¬æ¬¡å®¡è®¡ç°åœºç»“æœï¼‰ã€‚
å« dev ä¾èµ–ï¼šnpm --registry=https://registry.npmjs.org/ audit æŠ¥å‘Š glob 10.2.0 - 10.4.5 highï¼ˆå‘½ä»¤è¾“å‡ºæ˜¾ç¤ºç»ç”± eslint-config-next -> @next/eslint-plugin-next -> globï¼Œæœ¬æ¬¡å®¡è®¡ç°åœºç»“æœï¼‰ã€‚
ä¿®å¤å»ºè®®

ä¼˜å…ˆï¼šå‡çº§åˆ°åŒ…å«ä¿®å¤çš„ eslint-config-next/@next/eslint-plugin-next ç‰ˆæœ¬ï¼›è‹¥åªèƒ½é€šè¿‡ npm audit fix --force ä¸”æç¤ºå‡çº§åˆ° eslint-config-next@16.1.1 ä¸º breaking changeï¼Œåˆ™åº”ç»“åˆ Next ç‰ˆæœ¬è·¯çº¿ç»Ÿä¸€å‡çº§å¹¶è·‘å…¨é‡ lint/testã€‚
å¤‡é€‰ï¼šåœ¨ package.json ä½¿ç”¨ overrides å°† glob å¼ºåˆ¶æå‡åˆ°ä¿®å¤ç‰ˆæœ¬ï¼ˆéœ€è¦éªŒè¯ Next eslint æ’ä»¶å…¼å®¹æ€§ï¼‰ï¼Œå¹¶æŠŠ lint ä½œä¸º CI é—¨ç¦ã€‚
5) UI æ˜¯å¦ä¼šè®©ç”¨æˆ·è¯¯æ“ä½œå¯¼è‡´è¶Šæƒ/æ•æ„Ÿä¿¡æ¯æš´éœ²ï¼Ÿï¼ˆå¸¦è¯æ®ï¼‰
é«˜é£é™©ï¼šç®¡ç† UI ä¸ç®¡ç† API é»˜è®¤å¯èƒ½â€œæ— é‰´æƒå¯ç›´æ¥æ“ä½œâ€

UI èµ„æºç”± Go æœåŠ¡ç›´æ¥æŒ‚åœ¨ /ï¼šroutes.go (line 107)ï¼›åŒä¸€ mux ä¸Šä¹Ÿæ³¨å†Œäº†ç®¡ç†è·¯ç”±ï¼šroutes.go (line 93)ã€‚
ç”±äºé»˜è®¤ Auth.Enabled=falseï¼šconfig.go (line 399)ï¼Œä¸€æ—¦è¯¥æœåŠ¡è¢«æš´éœ²åˆ°å¯è®¿é—®ç½‘ç»œï¼ŒUI é¡µé¢é‡Œçš„åˆ›å»º/åˆ é™¤/å°ç¦ç­‰èƒ½åŠ›å°†å˜æˆæœªæˆæƒå¯ç”¨ï¼ˆå–å†³äºéƒ¨ç½²æ˜¯å¦å¯ç”¨ authï¼‰ã€‚
è¯¯æ“ä½œé£é™©ï¼šåˆ é™¤ç­‰ç ´åæ€§æ“ä½œç¼ºå°‘äºŒæ¬¡ç¡®è®¤

åˆ é™¤ç”¨æˆ·ï¼šæ—  confirm/äºŒæ¬¡ç¡®è®¤ï¼Œç›´æ¥è°ƒç”¨ onDelete(user.user_id)ï¼špage.tsx (line 296)ã€‚
åˆ é™¤å›¢é˜Ÿï¼šæ—  confirm/äºŒæ¬¡ç¡®è®¤ï¼špage.tsx (line 208)ã€‚
åˆ é™¤ç»„ç»‡ï¼šæ—  confirm/äºŒæ¬¡ç¡®è®¤ï¼špage.tsx (line 239)ã€‚
å¯¹æ¯”ï¼šAPI key åˆ é™¤æœ‰ confirmï¼ˆè¯´æ˜å›¢é˜Ÿå·²æ„è¯†åˆ°è¯¥ç±»é£é™©ï¼Œä½†æœªè¦†ç›–åˆ° users/teams/orgsï¼‰ï¼šapi-key-sheet.tsx (line 88)ã€‚
æ•æ„Ÿä¿¡æ¯å±•ç¤º

åˆ›å»º API key åä¼šåœ¨ UI æ˜æ–‡å±•ç¤ºå®Œæ•´ keyï¼ˆåˆç†ä½†éœ€æ›´å¼ºä¿æŠ¤ä¸å¼•å¯¼ï¼‰ï¼špage.tsx (line 310)ã€‚
UI å¨èƒæ¨¡å‹ï¼ˆç²¾ç®€ï¼‰
èµ„äº§ï¼šAPI keysï¼ˆæœ€é«˜ä»·å€¼ï¼‰ã€ç”¨æˆ·/å›¢é˜Ÿ/ç»„ç»‡ä¿¡æ¯ã€é¢„ç®—ä¸ spendã€å®¡è®¡æ—¥å¿—ã€‚
æ”»å‡»è€…ï¼šå…¬ç½‘åŒ¿åè®¿é—®è€…ã€åŒç½‘æ®µå†…éƒ¨æ”»å‡»è€…ã€è¢«é’“é±¼çš„ç®¡ç†å‘˜æµè§ˆå™¨ç¯å¢ƒï¼ˆæ¶æ„ç«™ç‚¹/æ’ä»¶/æ³¨å…¥è„šæœ¬ï¼‰ã€‚
å…¥å£/è¾¹ç•Œï¼š/ é™æ€ UIï¼ˆroutes.go (line 107)ï¼‰ä¸ç®¡ç† APIï¼ˆå¦‚ /key/*ã€/user/*ï¼Œroutes.go (line 14)ï¼‰ï¼›æ˜¯å¦å¯ç”¨ cfg.Auth.Enabled æ˜¯å”¯ä¸€å…³é”®è¾¹ç•Œï¼ˆmiddleware.go (line 20)ã€config.go (line 399)ï¼‰ã€‚
é£é™©æ¸…å•ä¸ä¿®å¤å»ºè®®ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰
Criticalï¼šé»˜è®¤æ— é‰´æƒæ—¶ç®¡ç†é¢å®Œå…¨æš´éœ²
ä¿®å¤ï¼šå¼ºåˆ¶â€œå¯ç”¨ç®¡ç† API/UI æ—¶å¿…é¡»å¯ç”¨é‰´æƒâ€ï¼Œæˆ–è‡³å°‘é»˜è®¤æŠŠç®¡ç†é¢ç»‘å®šåˆ° localhost/å†…ç½‘ï¼›å¹¶å°† UI é™æ€èµ„æºä¸ API é‰´æƒç­–ç•¥æ‹†åˆ†ï¼ˆå½“å‰æŠŠ API key/OIDC bearer middlewareå¥—åœ¨æ•´ä¸ª mux ä¸Šï¼Œä¼šè®©æµè§ˆå™¨åŠ è½½é™æ€èµ„æºä¹Ÿè¢«è¦æ±‚å¸¦ Authorizationï¼Œé€¼è¿«ç”¨æˆ·å…³é—­ authï¼‰ã€‚
Highï¼šç ´åæ€§æ“ä½œæ— ç¡®è®¤ï¼ˆè¯¯åˆ /è¯¯æ“ä½œï¼‰
ä¿®å¤ï¼šä¸º users/teams/organizations çš„ delete å¢åŠ äºŒæ¬¡ç¡®è®¤ï¼ˆæœ€å¥½æ˜¯â€œè¾“å…¥èµ„æºåç¡®è®¤â€ï¼‰ï¼Œå¹¶åœ¨ UI ä¸Šæ˜ç¡®æ˜¾ç¤ºå½±å“èŒƒå›´ã€‚
Highï¼šç¼ºå°‘å®‰å…¨å“åº”å¤´ï¼ˆç‚¹å‡»åŠ«æŒ/é™çº§é˜²æŠ¤ï¼‰
ä¿®å¤ï¼šåœ¨ Go é™æ€èµ„æºä¸ API å±‚ç»Ÿä¸€åŠ  Content-Security-Policyã€X-Frame-Options/frame-ancestorsã€X-Content-Type-Optionsã€Referrer-Policyã€Permissions-Policyï¼ˆå½“å‰å…¨ä»“æœªè§è¿™äº›å¤´çš„è®¾ç½®ï¼šrg æ— ç»“æœï¼‰ã€‚
Mediumï¼šdev ä¾èµ– high æ¼æ´ï¼ˆglob CLI å‘½ä»¤æ³¨å…¥ï¼‰
ä¿®å¤ï¼šå‡çº§ eslint/next ç›¸å…³ä¾èµ–æˆ–ç”¨ overrides å®šç‚¹ä¿®å¤ï¼›åœ¨ CI ä¸­å›ºå®š registry å¹¶è·‘ npm auditã€‚
Mediumï¼šè”è°ƒæœŸ CORS/ä»£ç†é…ç½®æ˜“è¯±å¯¼â€œæ”¾å¼€è·¨åŸŸâ€
ä¿®å¤ï¼šè®© next.config.mjs çš„ rewrite è¦†ç›–å®é™…ç®¡ç† API è·¯å¾„ï¼Œæˆ–ç»Ÿä¸€å‰ç¼€ï¼ˆä¾‹å¦‚å…¨éƒ¨èµ° /api/v1ï¼‰ï¼Œé¿å…å¼€å‘è€…ç”¨ allow_all_origins ä¹‹ç±»çš„ç²—æš´é…ç½®è·‘é€šè”è°ƒã€‚
